<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>بایگانی نشریات ایران</title>
	<style>
		body {
			--body-bg: #f4f4f4;
			--text-color: #333;
			--control-bg: #fff;
			--border-color: #ddd;
			--button-bg: #28a745;
			--button-hover-bg: #000;
			--button-disabled-bg: #cccccc;
			--error-color: red;
			--status-color: #007bff;
			--section-bg: #fff;
			--section-title-color: #555;
			--lightbox-bg: #fff;
			--lightbox-text-color: #333;
			--lightbox-button-bg: #007bff;
			--lightbox-button-hover-bg: #000;
			--lightbox-close-button-color: #333;

			--highlight-color-r: 40;
			--highlight-color-g: 167;
			--highlight-color-b: 69;

			--highlight-color: rgb(var(--highlight-color-r), var(--highlight-color-g), var(--highlight-color-b));
			--highlight-text-color: white;
			--multiple-issues-color: #ffc107;
		}

		@media (prefers-color-scheme: dark) {
			body {
				--body-bg: #1a1a1a;
				--text-color: #e0e0e0;
				--control-bg: #2a2a2a;
				--border-color: #555;
				--button-bg: #1e7e34;
				--button-hover-bg: #aaa;
				--button-disabled-bg: #555555;
				--error-color: #ff6666;
				--status-color: #66b3ff;
				--section-bg: #2a2a2a;
				--section-title-color: #cccccc;
				--lightbox-bg: #3a3a3a;
				--lightbox-text-color: #e0e0e0;
				--lightbox-button-bg: #0056b3;
				--lightbox-button-hover-bg: #aaa;
				--lightbox-close-button-color: #e0e0e0;

				--highlight-color-r: 30;
				--highlight-color-g: 126;
				--highlight-color-b: 52;

				--highlight-color: rgb(var(--highlight-color-r), var(--highlight-color-g), var(--highlight-color-b));
				--highlight-text-color: white;
				--multiple-issues-color: #d4a700;
			}
		}

		body {
			font-family: system-ui;
			display: flex;
			flex-direction: column;
			align-items: center;
			margin: 20px;
			background-color: var(--body-bg);
			color: var(--text-color);
			transition: background-color 0.3s, color 0.3s;
		}
		.controls {
			margin-bottom: 10px;
			background-color: var(--control-bg);
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
			justify-content: center;
		}
		.global-issue-nav-controls {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
			justify-content: center;
			flex-wrap: wrap;
		}
		.global-issue-nav-controls button {
			padding: 8px 15px;
			color: white;
			border: 2px solid transparent;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
		}
		.global-issue-nav-controls button {
			background-color: var(--button-bg);
		}
		.global-issue-nav-controls button:hover {
			background-color: var(--button-hover-bg);
		}

		.global-issue-nav-controls button.shamsi-nav-btn {
			background-color: var(--lightbox-button-bg);
		}
		.global-issue-nav-controls button.shamsi-nav-btn:hover {
			background-color: var(--lightbox-button-hover-bg);
		}
		.global-issue-nav-controls button.hijri-nav-btn {
			background-color: var(--button-bg);
		}
		.global-issue-nav-controls button.hijri-nav-btn:hover {
			background-color: var(--button-hover-bg);
		}

		.global-issue-nav-controls button.available-on-date {
			 box-shadow: 0px 6px 0px 0px;
		}
		.global-issue-nav-controls button.hijri-nav-btn.available-on-date {
			border-color: var(--button-hover-bg);
			box-shadow: 0px 6px 0px 0px var(--button-hover-bg);
		}
		.global-issue-nav-controls button.shamsi-nav-btn.available-on-date {
			border-color: var(--lightbox-button-hover-bg);
			box-shadow: 0px 6px 0px 0px var(--lightbox-button-hover-bg);
		}


		.global-issue-nav-controls button:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
			border-color: transparent;
			box-shadow: none;
		}
		.controls label {
			margin-left: 5px;
		}
		.controls select, .controls input[type="number"] {
			padding: 8px;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			font-size: 16px;
			background-color: var(--control-bg);
			color: var(--text-color);
			font-family: system-ui;
		}
		.newspaper-container {
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
			gap: 20px;
			width: 100%;
			max-width: 1150px;
		}
		.newspaper-section {
			flex: 1;
			min-width: 330px;
			max-width: 370px;
			text-align: center;
			background-color: var(--section-bg);
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.newspaper-section.no-image {
			min-width: 200px;
			max-width: 250px;
		}
		.newspaper-section h2 {
			margin-top: 0;
			color: var(--section-title-color);
			font-weight: normal;
		}
		.newspaper-section.available-newspaper h2 {
			font-weight: bold;
		}
		.image-container {
			max-width: 100%;
			height: auto;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			cursor: pointer;
			margin: 0 auto;
			display: block;
			position: relative;
		}
		.newspaper-image {
			max-width: 100%;
			height: auto;
			border-radius: 4px;
			display: block;
			cursor: pointer;
		}
		.image-placeholder {
			width: 330px;
			height: 500px;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #e0e0e0;
			color: #555;
			border-radius: 4px;
			padding: 5px;
			box-sizing: border-box;
			text-align: center;
		}
		.newspaper-section.no-image .image-placeholder {
			width: 200px;
			height: 300px;
		}
		.utlib-download-link {
			display: flex;
			align-items: center;
			justify-content: center;
			width: 100%;
			height: 100%;
			background-color: var(--lightbox-button-bg);
			color: white;
			border-radius: 4px;
			text-decoration: none;
			font-size: 1.2em;
			padding: 10px;
			box-sizing: border-box;
		}
		.error-message {
			color: var(--error-color);
			margin-top: 10px;
			text-align: center;
			width: 100%;
		}
		.status-message {
			color: var(--status-color);
			margin-top: 10px;
			text-align: center;
			width: 100%;
		}
		.pagination-controls {
			margin-top: 15px;
			display: flex;
			align-items: center;
			gap: 10px;
		}
		.pagination-controls button {
			padding: 8px 15px;
			background-color: var(--button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease;
		}
		.pagination-controls button:hover {
			background-color: var(--button-hover-bg);
		}
		.pagination-controls button:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
		}
		.pagination-controls input[type="number"] {
			width: 60px;
			text-align: center;
			background-color: var(--control-bg);
			color: var(--text-color);
		}

		button
		{
			font-family: system-ui;
		}

		.all-issues-modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 1001;
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s ease, visibility 0.3s ease;
		}
		.all-issues-modal-overlay.visible {
			opacity: 1;
			visibility: visible;
		}
		.all-issues-modal-content {
			position: relative;
			background-color: var(--lightbox-bg);
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
			color: var(--lightbox-text-color);
			max-width: 90%;
			max-height: 95vh;
			height: 100%;
			display: flex;
			flex-direction: column;
			overflow-y: auto;
		}
		h2#allIssuesModalNewspaperTitle {
			text-align: center;
			margin-top: 0;
			margin-bottom: 15px;
		}
		.all-issues-modal-close-button {
			position: absolute;
			top: 10px;
			right: 10px;
			background: none;
			border: none;
			font-size: 24px;
			cursor: pointer;
			color: var(--lightbox-close-button-color);
		}
		.calendar-modal-close-button {
			position: absolute;
			top: 20px;
			right: 20px;
			background: none;
			border: none;
			font-size: 28px;
			cursor: pointer;
			color: var(--lightbox-close-button-color);
		}
		.newspaper-selection-container {
			display: flex;
			flex-wrap: wrap;
			gap: 10px;
			margin-bottom: 20px;
			justify-content: center;
			padding-bottom: 10px;
			border-bottom: 1px solid var(--border-color);
			max-height: 20vh;
		}
		.newspaper-selection-container button {
			padding: 8px 15px;
			background-color: #6c757d;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 15px;
			transition: background-color 0.3s ease;
			white-space: nowrap;
		}
		.newspaper-selection-container button:hover {
			background-color: #5a6268;
		}
		.newspaper-selection-container button.selected {
			background-color: #007bff;
		}

		.issues-list-container {
			display: flex;
			flex-wrap: wrap;
			gap: 8px;
			margin-top: 15px;
			padding-right: 10px;
			overflow-y: auto;
			flex-grow: 1;
			align-content: flex-start;
		}
		.issues-list-container .issue-item-button {
			padding: 8px 12px;
			background-color: var(--button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease;
			white-space: nowrap;
			text-decoration: none;
		}
		.issues-list-container .issue-item-button:hover {
			background-color: var(--button-hover-bg);
		}
		.global-all-issues-btn {
			margin-right: 10px;
			padding: 8px 15px;
			background-color: var(--lightbox-button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease;
		}
		.global-all-issues-btn:hover {
			background-color: var(--lightbox-button-hover-bg);
		}
		.view-all-issues-btn {
			margin-top: 10px;
			padding: 8px 15px;
			background-color: var(--lightbox-button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease;
		}
		.view-all-issues-btn:hover {
			background-color: var(--lightbox-button-hover-bg);
		}

		.modal-controls {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
			margin-bottom: 10px;
			flex-wrap: wrap;
		}
		.modal-controls input[type="checkbox"] {
			width: 18px;
			height: 18px;
			cursor: pointer;
			accent-color: var(--button-bg);
		}
		.modal-controls label {
			font-size: 16px;
			color: var(--text-color);
		}

		/* New styles for image grid */
		.issues-image-grid-container {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
			gap: 10px;
			margin-top: 15px;
			padding-right: 10px;
			overflow-y: auto;
			flex-grow: 1;
			align-content: flex-start;
			justify-items: center;
		}

		.issue-thumbnail-item {
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
			cursor: pointer;
			background-color: var(--control-bg);
			border-radius: 8px;
			padding: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			transition: transform 0.2s ease, box-shadow 0.2s ease;
			width: 120px;
			box-sizing: border-box;
		}

		.issue-thumbnail-item:hover {
			transform: translateY(-3px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		.issue-thumbnail-image {
			width: 100%;
			height: auto;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			margin-bottom: 5px;
			object-fit: contain;
			max-height: 180px;
		}
		.newspaper-image-placeholder {
			width: 100%;
			height: 180px;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #e0e0e0;
			color: #555;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 5px;
			box-sizing: border-box;
			text-align: center;
		}
		.lightbox-image-placeholder {
			width: 800px;
			height: 1200px;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: #e0e0e0;
			color: #555;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 20px;
			box-sizing: border-box;
			text-align: center;
			font-size: 1.5em;
		}

		.issue-thumbnail-text {
			font-size: 0.85em;
			color: var(--text-color);
			word-break: break-word;
		}

		.volume-header {
			width: 100%;
			text-align: center;
			margin-top: 15px;
			margin-bottom: 10px;
			font-size: 1.2em;
			font-weight: bold;
			color: var(--section-title-color);
			padding: 5px 0;
			border-bottom: 1px solid var(--border-color);
		}

		.lightbox-overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.3s ease, visibility 0.3s ease;
		}
		.lightbox-overlay.visible {
			opacity: 1;
			visibility: visible;
		}
		.lightbox-content {
			position: relative;
			max-width: 90%;
			max-height: 90vh;
			display: flex;
			flex-direction: column;
			align-items: center;
			background-color: var(--lightbox-bg);
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
			color: var(--lightbox-text-color);
			overflow-y: auto;
		}
		.lightbox-image {
			max-width: 100%;
			max-height: calc(90vh - 200px);
			height: auto;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			cursor: pointer;
			margin: 0 auto;
			display: block;
		}
		.lightbox-controls {
			display: flex;
			justify-content: center;
			flex-wrap: wrap;
			width: 100%;
			margin-top: 15px;
			gap: 10px;
		}
		.lightbox-controls .page-nav,
		.lightbox-controls .newspaper-nav,
		.lightbox-controls .issue-nav-lightbox {
			display: flex;
			align-items: center;
			gap: 5px;
		}
		.lightbox-controls button {
			padding: 10px 20px;
			background-color: var(--lightbox-button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s ease;
		}
		.lightbox-controls button:hover {
			background-color: var(--lightbox-button-hover-bg);
		}
		.lightbox-controls button:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
		}
		.lightbox-controls input[type="number"] {
			width: 70px;
			text-align: center;
			padding: 8px;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			font-size: 16px;
			background-color: var(--control-bg);
			color: var(--text-color);
		}
		.lightbox-controls .view-all-issues-btn {
			background-color: #6c757d;
		}
		.lightbox-controls .view-all-issues-btn:hover {
			background-color: #5a6268;
		}


		.lightbox-close-button {
			position: absolute;
			top: 10px;
			right: 10px;
			background: none;
			border: none;
			font-size: 24px;
			cursor: pointer;
			color: var(--lightbox-close-button-color);
		}
		.lightbox-links {
			margin-top: 15px;
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
		}
		.lightbox-links a {
			padding: 8px 15px;
			background-color: #4CAF50;
			color: white;
			text-decoration: none;
			border-radius: 4px;
			transition: background-color 0.3s ease;
		}
		.lightbox-links a:hover {
			background-color: #45a049;
		}
		.calendar-selection {
			display: flex;
			gap: 15px;
			justify-content: center;
			align-items: center;
		}
		.calendar-selection label {
			cursor: pointer;
			padding: 8px 15px;
			border-radius: 5px;
			border: 1px solid var(--border-color);
			background-color: var(--control-bg);
			transition: background-color 0.3s, border-color 0.3s;
		}
		.calendar-selection input[type="radio"] {
			display: none;
		}
		.calendar-selection input[type="radio"]:checked + label {
			color: white;
		}
		.calendar-selection input[type="radio"]#shamsiCalendar:checked + label {
			background-color: var(--lightbox-button-bg);
			border-color: var(--lightbox-button-bg);
		}
		.calendar-selection input[type="radio"]#hijriCalendar:checked + label {
			background-color: var(--button-bg);
			border-color: var(--button-bg);
		}
		.issue-navigation-controls {
			margin-top: 10px;
			display: none;
			text-align: center;
			width: 100%;
		}
		.issue-navigation-controls > div {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
		}
		.issue-navigation-controls button {
			padding: 8px 15px;
			background-color: var(--button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		 .issue-navigation-controls button:hover {
			background-color: var(--button-hover-bg);
		}
		.issue-navigation-controls button:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
		}
		.issue-navigation-controls input[type="number"] {
			width: 60px;
			padding: 8px;
			text-align: center;
			border: 1px solid var(--border-color);
			border-radius: 4px;
			background-color: var(--control-bg);
			color: var(--text-color);
		}

		button
		{
			font-family: system-ui;
		}

		/* Calendar specific styles */
		h2#calendarModalTitle{
			text-align: center;
			margin-top: 0;
		}
		h2#shamsiCalendarModalTitle{
			text-align: center;
			margin-top: 0;
		}
		.calendar-nav {
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
			margin-bottom: 20px;
		}
		.calendar-nav button {
			padding: 8px 15px;
			background-color: var(--button-bg);
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			transition: background-color 0.3s ease;
		}
		.calendar-nav button:hover {
			background-color: var(--button-hover-bg);
		}
		.calendar-nav button:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
		}
		#calendarYearSelect {
			font-size: 1.2em;
			font-weight: bold;
			color: var(--text-color);
			background-color: var(--control-bg);
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 5px 10px;
			font-family: system-ui;
		}
		#shamsiCalendarYearSelect {
			font-size: 1.2em;
			font-weight: bold;
			color: var(--text-color);
			background-color: var(--control-bg);
			border: 1px solid var(--border-color);
			border-radius: 4px;
			padding: 5px 10px;
			font-family: system-ui;
		}
		.calendar-grid-container {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 10px;
			width: 100%;
			overflow-y: auto;
			flex-grow: 1;
		}
		.calendar-month {
			background-color: var(--control-bg);
			padding: 5px;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0,0,0,0.05);
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.calendar-month h3 {
			margin-top: 0;
			margin-bottom: 10px;
			color: var(--section-title-color);
			font-size: 1.1em;
		}
		.calendar-days {
			display: grid;
			grid-template-columns: repeat(7, 1fr);
			gap: 5px;
			width: 100%;
		}
		.calendar-day-btn {
			width: 28px;
			height: 28px;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 0;
			border: none;
			border-radius: 20px;
			color: var(--section-title-color);
			font-size: 0.8em;
			cursor: pointer;
			transition: background-color 0.2s, transform 0.1s;
			box-sizing: border-box;
			background: none;
		}

		.calendar-day-btn:hover {
			background-color: var(--border-color);
			transform: scale(1.05);
		}
		.calendar-day-btn.has-issue {
			color: var(--text-color);
			font-weight: normal;
			border-color: var(--highlight-color);
		}
		.calendar-day-btn.issue-count-1 {
			background-color: rgba(var(--highlight-color-r), var(--highlight-color-g), var(--highlight-color-b), 0.2);
		}
		.calendar-day-btn.issue-count-2 {
			background-color: rgba(var(--highlight-color-r), var(--highlight-color-g), var(--highlight-color-b), 0.5);
		}
		.calendar-day-btn.issue-count-3plus {
			background-color: rgb(var(--highlight-color-r), var(--highlight-color-g), var(--highlight-color-b));
		}

		.calendar-day-btn.selected-day {
			background-color: var(--multiple-issues-color);
		}
		@media (prefers-color-scheme: dark) {
			.calendar-day-btn.selected-day {
					border: 2px solid var(--multiple-issues-color);
					background-color: var(--multiple-issues-color);
					color: black;
			}
		}

		.calendar-day-btn:disabled {
			background-color: var(--button-disabled-bg);
			cursor: not-allowed;
			color: #888;
			border-color: #888;
			opacity: 1;
		}

		@media (max-width: 768px) {
			.calendar-grid-container {
				grid-template-columns: repeat(2, 1fr);
			}
			/* Hide labels for year, month, day on mobile */
			#shamsiDateControls label[for="shamsiYear"],
			#shamsiDateControls label[for="shamsiMonth"],
			#shamsiDateControls label[for="shamsiDay"],
			#hijriDateControls label[for="hijriYear"],
			#hijriDateControls label[for="hijriMonth"],
			#hijriDateControls label[for="hijriDay"] {
				display: none;
			}
			#shamsiDateControls, #hijriDateControls {
				display: flex;
				flex-direction: row;
				align-items: center;
				justify-content: center;
				flex-wrap: wrap;
			}
			/* Swap order of Day and Year */
			#shamsiDateControls #shamsiDay,
			#hijriDateControls #hijriDay {
				order: 1;
			}
			#shamsiDateControls #shamsiMonth,
			#hijriDateControls #hijriMonth {
				order: 2;
			}
			#shamsiDateControls #shamsiYear,
			#hijriDateControls #hijriYear {
				order: 3;
			}
		}

		@media (max-width: 480px) {
			.calendar-grid-container {
				grid-template-columns: repeat(2, 1fr);
				gap: 5px;
			}
			.calendar-day-btn {
				width: 21px;
				height: 21px;
				font-size: 0.85em;
			}
		}

	</style>
</head>
<body>
	<h1>بایگانی نشریات ایران</h1>

	<div class="controls">
		<div class="calendar-selection">
			<input type="radio" id="hijriCalendar" name="calendar" value="hijri">
			<label for="hijriCalendar">قمری</label>
			<input type="radio" id="shamsiCalendar" name="calendar" value="shamsi" checked>
			<label for="shamsiCalendar">شمسی</label>
		</div>

		<div id="shamsiDateControls" style="display: block;">
			<label for="shamsiDay">روز:</label>
			<select id="shamsiDay"></select>
			<label for="shamsiMonth">ماه:</label>
			<select id="shamsiMonth">
				<option value="1">فروردین</option>
				<option value="2">اردیبهشت</option>
				<option value="3">خرداد</option>
				<option value="4">تیر</option>
				<option value="5" selected>مرداد</option>
				<option value="6">شهریور</option>
				<option value="7">مهر</option>
				<option value="8">آبان</option>
				<option value="9">آذر</option>
				<option value="10">دی</option>
				<option value="11">بهمن</option>
				<option value="12">اسفند</option>
			</select>
			<label for="shamsiYear">سال:</label>
			<select id="shamsiYear"></select>
		</div>

		<div id="hijriDateControls" style="display: none;">
			<label for="hijriDay">روز:</label>
			<select id="hijriDay"></select>
			<label for="hijriMonth">ماه:</label>
			<select id="hijriMonth">
				<option value="1">محرم</option>
				<option value="2">صفر</option>
				<option value="3">ربیع‌الاول</option>
				<option value="4">ربیع‌الثانی</option>
				<option value="5">جمادی‌الاول</option>
				<option value="6">جمادی‌الثانی</option>
				<option value="7">رجب</option>
				<option value="8">شعبان</option>
				<option value="9">رمضان</option>
				<option value="10">شوال</option>
				<option value="11">ذی‌القعده</option>
				<option value="12">ذی‌الحجه</option>
			</select>
			<label for="hijriYear">سال:</label>
			<select id="hijriYear"></select>
		</div>
		<button id="openCalendarModalBtn" class="global-all-issues-btn">تقویم</button>
		<button id="openAllNewspapersIssuesModalBtn" class="global-all-issues-btn">فهرست شماره‌های نشریات</button>
	</div>
	<div id="globalGoToFirstIssueControls" class="global-issue-nav-controls">
	</div>

	<p id="mainErrorMessage" class="error-message" style="display: none;"></p>
	<p id="mainStatusMessage" class="status-message">در حال بارگذاری نشریات...</p>

	<div class="newspaper-container">
	</div>

	<div class="pagination-controls" style="margin-top: 20px;">
		<label for="mainPageNumberInput">صفحه اصلی:</label>
		<input type="number" id="mainPageNumberInput" value="1" min="1">
	</div>

	<div id="lightboxOverlay" class="lightbox-overlay">
		<div class="lightbox-content">
			<button id="lightboxCloseButton" class="lightbox-close-button">&times;</button>
			<h2 id="lightboxNewspaperTitle"></h2>
			<div class="image-container">
				<img id="lightboxImage" src="" alt="تصویر نشریه در لایت‌باکس" class="lightbox-image">
				<div id="lightboxImagePlaceholder" class="lightbox-image-placeholder" style="display: none;">تصویر در دسترس نیست</div>
			</div>
			<p id="lightboxStatusMessage" class="status-message" style="display: none;"></p>
			<p id="lightboxErrorMessage" class="error-message" style="display: none;"></p>

			<div class="lightbox-links">
				<a id="downloadLink" href="#" target="_blank" style="display: none;">دانلود نشریه</a>
				<a id="viewLargeLink" href="#" target="_blank" style="display: none;">تصویر بزرگتر</a>
			</div>

			<div class="lightbox-controls">
				<div class="page-nav">
					<button id="lightboxPrevPageButton">&lt;</button>
					<input type="number" id="lightboxPageNumberInput" value="1" min="1">
					<button id="lightboxNextPageButton">&gt;</button>
				</div>
				<div class="issue-nav-lightbox" style="display: none;">
					<button id="lightboxPrevIssueButton" class="lightbox-issue-nav-btn">&lt; شماره قبل</button>
					<input type="number" id="lightboxIssueNumberInput" value="" min="1" disabled>
					<button id="lightboxNextIssueButton" class="lightbox-issue-nav-btn">شماره بعد &gt;</button>
					<button id="lightboxViewAllIssuesButton" class="lightbox-issue-nav-btn view-all-issues-btn">مشاهده تمام شماره‌ها</button>
				</div>
				<div class="newspaper-nav">
					<button id="lightboxPrevNewspaperButton" style="display: none;">نشریه قبل</button>
					<button id="lightboxNextNewspaperButton" style="display: none;">نشریه بعد</button>
				</div>
			</div>
		</div>
	</div>

	<div id="allIssuesModalOverlay" class="all-issues-modal-overlay">
		<div class="all-issues-modal-content">
			<button id="allIssuesModalCloseButton" class="all-issues-modal-close-button">&times;</button>
			<h2 id="allIssuesModalNewspaperTitle">فهرست شماره‌های نشریات</h2>
			<div class="modal-controls">
				<input type="checkbox" id="showDatesCheckbox">
				<label for="showDatesCheckbox">نمایش تاریخ‌ها</label>
				<input type="checkbox" id="showImagesCheckbox">
				<label for="showImagesCheckbox">نمایش تصاویر</label>
			</div>
			<div id="newspaperSelectionContainer" class="newspaper-selection-container">
			</div>
			<div id="issuesListContainer" class="issues-list-container">
			</div>
			<div id="issuesImageGridContainer" class="issues-image-grid-container" style="display: none;">
			</div>
			<p id="allIssuesModalErrorMessage" class="error-message" style="display: none;"></p>
		</div>
	</div>

	<div id="calendarModalOverlay" class="all-issues-modal-overlay">
		<div class="all-issues-modal-content">
			<button id="calendarModalCloseButton" class="calendar-modal-close-button">&times;</button>
			<h2 id="calendarModalTitle">تقویم قمری</h2>
			<div class="calendar-nav">
				<button id="prevYearBtn">&lt; سال قبل</button>
				<select id="calendarYearSelect"></select>
				<button id="nextYearBtn">سال بعد &gt;</button>
			</div>
			<div id="calendarGridContainer" class="calendar-grid-container">
			</div>
			<p id="calendarModalErrorMessage" class="error-message" style="display: none;"></p>
		</div>
	</div>

	<!-- New Shamsi Calendar Modal -->
	<div id="shamsiCalendarModalOverlay" class="all-issues-modal-overlay">
		<div class="all-issues-modal-content">
			<button id="shamsiCalendarModalCloseButton" class="calendar-modal-close-button">&times;</button>
			<h2 id="shamsiCalendarModalTitle">تقویم شمسی</h2>
			<div class="calendar-nav">
				<button id="shamsiPrevYearBtn">&lt; سال قبل</button>
				<select id="shamsiCalendarYearSelect"></select>
				<button id="shamsiNextYearBtn">سال بعد &gt;</button>
			</div>
			<div id="shamsiCalendarGridContainer" class="calendar-grid-container">
			</div>
			<p id="shamsiCalendarModalErrorMessage" class="error-message" style="display: none;"></p>
		</div>
	</div>

	<script>
		var MD5 = function(d){var r = M(V(Y(X(d),8*d.length)));return r.toLowerCase()};function M(d){for(var _,m="0123456789ABCDEF",f="",r=0;r<d.length;r++)_=d.charCodeAt(r),f+=m.charAt(_>>>4&15)+m.charAt(15&_);return f}function X(d){for(var _=Array(d.length>>2),m=0;m<_.length;m++)_[m]=0;for(m=0;m<8*d.length;m+=8)_[m>>5]|=(255&d.charCodeAt(m/8))<<m%32;return _}function V(d){for(var _="",m=0;m<32*d.length;m+=8)_+=String.fromCharCode(d[m>>5]>>>m%32&255);return _}function Y(d,_){d[_>>5]|=128<<_%32,d[14+(_+64>>>9<<4)]=_;for(var m=1732584193,f=-271733879,r=-1732584194,i=271733878,n=0;n<d.length;n+=16){var h=m,t=f,g=r,e=i;f=md5_ii(f=md5_ii(f=md5_ii(f=md5_ii(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_hh(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_gg(f=md5_ff(f=md5_ff(f=md5_ff(f=md5_ff(f,r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+0],7,-680876936),f,r,d[n+1],12,-389564586),m,f,d[n+2],17,606105819),i,m,d[n+3],22,-1044525330),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+4],7,-176418897),f,r,d[n+5],12,1200080426),m,f,d[n+6],17,-1473231341),i,m,d[n+7],22,-45705983),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+8],7,1770035416),f,r,d[n+9],12,-1958414417),m,f,d[n+10],17,-42063),i,m,d[n+11],22,-1990404162),r=md5_ff(r,i=md5_ff(i,m=md5_ff(m,f,r,i,d[n+12],7,1804603682),f,r,d[n+13],12,-40341101),m,f,d[n+14],17,-1502002290),i,m,d[n+15],22,1236535329),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+1],5,-165796510),f,r,d[n+6],9,-1069501632),m,f,d[n+11],14,643717713),i,m,d[n+0],20,-373897302),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+5],5,-701558691),f,r,d[n+10],9,38016083),m,f,d[n+15],14,-660478335),i,m,d[n+4],20,-405537848),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+9],5,568446438),f,r,d[n+14],9,-1019803690),m,f,d[n+3],14,-187363961),i,m,d[n+8],20,1163531501),r=md5_gg(r,i=md5_gg(i,m=md5_gg(m,f,r,i,d[n+13],5,-1444681467),f,r,d[n+2],9,-51403784),m,f,d[n+7],14,1735328473),i,m,d[n+12],20,-1926607734),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+5],4,-378558),f,r,d[n+8],11,-2022574463),m,f,d[n+11],16,1839030562),i,m,d[n+14],23,-35309556),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+1],4,-1530992060),f,r,d[n+4],11,1272893353),m,f,d[n+7],16,-155497632),i,m,d[n+10],23,-1094730640),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+13],4,681279174),f,r,d[n+0],11,-358537222),m,f,d[n+3],16,-722521979),i,m,d[n+6],23,76029189),r=md5_hh(r,i=md5_hh(i,m=md5_hh(m,f,r,i,d[n+9],4,-640364487),f,r,d[n+12],11,-421815835),m,f,d[n+15],16,530742520),i,m,d[n+2],23,-995338651),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+0],6,-198630844),f,r,d[n+7],10,1126891415),m,f,d[n+14],15,-1416354905),i,m,d[n+5],21,-57434055),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+12],6,1700485571),f,r,d[n+3],10,-1894986606),m,f,d[n+10],15,-1051523),i,m,d[n+1],21,-2054922799),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+8],6,1873313359),f,r,d[n+15],10,-30611744),m,f,d[n+6],15,-1560198380),i,m,d[n+13],21,1309151649),r=md5_ii(r,i=md5_ii(i,m=md5_ii(m,f,r,i,d[n+4],6,-145523070),f,r,d[n+11],10,-1120210379),m,f,d[n+2],15,718787259),i,m,d[n+9],21,-343485551),m=safe_add(m,h),f=safe_add(f,t),r=safe_add(r,g),i=safe_add(i,e)}return Array(m,f,r,i)}function md5_cmn(d,_,m,f,r,i){return safe_add(bit_rol(safe_add(safe_add(_,d),safe_add(f,i)),r),m)}function md5_ff(d,_,m,f,r,i,n){return md5_cmn(_&m|~_&f,d,_,r,i,n)}function md5_gg(d,_,m,f,r,i,n){return md5_cmn(_&f|m&~f,d,_,r,i,n)}function md5_hh(d,_,m,f,r,i,n){return md5_cmn(_^m^f,d,_,r,i,n)}function md5_ii(d,_,m,f,r,i,n){return md5_cmn(m^(_|~f),d,_,r,i,n)}function safe_add(d,_){var m=(65535&d)+(65535&_);return(d>>16)+(_>>16)+(m>>16)<<16|65535&m}function bit_rol(d,_){return d<<_|d>>>32-_}

		document.addEventListener('DOMContentLoaded', async () => {
			const pad = (num) => num.toString().padStart(2, '0');
			const persianToEnglishDigits = (str) => {
				if (typeof str !== 'string') return str;
				const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
				const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
				return str.split('').map(char => {
					const index = persianNumbers.indexOf(char);
					return index !== -1 ? englishNumbers[index] : char;
				}).join('');
			};
			const englishToPersianDigits = (str) => {
				if (typeof str !== 'string' && typeof str !== 'number') return str;
				str = String(str);
				const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
				const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
				return str.split('').map(char => {
					const index = englishNumbers.indexOf(char);
					return index !== -1 ? persianNumbers[index] : char;
				}).join('');
			};

			const getUrlParameter = (name) => {
				name = name.replace(/[\[\]]/g, '\\$&');
				const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
				const results = regex.exec(window.location.href);
				if (!results) return null;
				if (!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, ' '));
			};
			const updateUrlParameters = (calendar, year, month, day) => {
				const newUrl = `${window.location.pathname}?calendar=${calendar}&year=${year}&month=${month}&day=${day}`;
				window.history.pushState({}, '', newUrl);
			};

			const parseDateString = (dateStr) => {
				if (!dateStr || dateStr.length !== 8) return null;
				const year = parseInt(dateStr.substring(0, 4), 10);
				const month = parseInt(dateStr.substring(4, 6), 10);
				const day = parseInt(dateStr.substring(6, 8), 10);
				return { year, month, day };
			};

			const shamsiCalendarRadio = document.getElementById('shamsiCalendar');
			const hijriCalendarRadio = document.getElementById('hijriCalendar');
			const shamsiDateControls = document.getElementById('shamsiDateControls');
			const hijriDateControls = document.getElementById('hijriDateControls');
			const shamsiYearInput = document.getElementById('shamsiYear');
			const shamsiMonthSelect = document.getElementById('shamsiMonth');
			const shamsiDayInput = document.getElementById('shamsiDay');
			const hijriYearInput = document.getElementById('hijriYear');
			const hijriMonthSelect = document.getElementById('hijriMonth');
			const hijriDayInput = document.getElementById('hijriDay');
			const mainErrorMessage = document.getElementById('mainErrorMessage');
			const mainStatusMessage = document.getElementById('mainStatusMessage');
			const mainPageNumberInput = document.getElementById('mainPageNumberInput');
			const lightboxOverlay = document.getElementById('lightboxOverlay');
			const lightboxCloseButton = document.getElementById('lightboxCloseButton');
			const lightboxNewspaperTitle = document.getElementById('lightboxNewspaperTitle');
			const lightboxImage = document.getElementById('lightboxImage');
			const lightboxImagePlaceholder = document.getElementById('lightboxImagePlaceholder');
			const lightboxStatusMessage = document.getElementById('lightboxStatusMessage');
			const lightboxErrorMessage = document.getElementById('lightboxErrorMessage');
			const lightboxPrevPageButton = document.getElementById('lightboxPrevPageButton');
			const lightboxNextPageButton = document.getElementById('lightboxNextPageButton');
			const lightboxPageNumberInput = document.getElementById('lightboxPageNumberInput');
			const lightboxPrevNewspaperButton = document.getElementById('lightboxPrevNewspaperButton');
			const lightboxNextNewspaperButton = document.getElementById('lightboxNextNewspaperButton');
			const downloadLink = document.getElementById('downloadLink');
			const viewLargeLink = document.getElementById('viewLargeLink');
			const newspaperContainer = document.querySelector('.newspaper-container');
			const globalGoToFirstIssueControls = document.getElementById('globalGoToFirstIssueControls');

			const issueNavLightbox = document.querySelector('.issue-nav-lightbox');
			const lightboxPrevIssueButton = document.getElementById('lightboxPrevIssueButton');
			const lightboxIssueNumberInput = document.getElementById('lightboxIssueNumberInput');
			const lightboxNextIssueButton = document.getElementById('lightboxNextIssueButton');
			const lightboxViewAllIssuesButton = document.getElementById('lightboxViewAllIssuesButton');


			const openAllNewspapersIssuesModalBtn = document.getElementById('openAllNewspapersIssuesModalBtn');
			const allIssuesModalOverlay = document.getElementById('allIssuesModalOverlay');
			const allIssuesModalCloseButton = document.getElementById('allIssuesModalCloseButton');
			const allIssuesModalNewspaperTitle = document.getElementById('allIssuesModalNewspaperTitle');
			const newspaperSelectionContainer = document.getElementById('newspaperSelectionContainer');
			const issuesListContainer = document.getElementById('issuesListContainer');
			const issuesImageGridContainer = document.getElementById('issuesImageGridContainer');
			const allIssuesModalErrorMessage = document.getElementById('allIssuesModalErrorMessage');
			const showDatesCheckbox = document.getElementById('showDatesCheckbox');
			const showImagesCheckbox = document.getElementById('showImagesCheckbox');

			const openCalendarModalBtn = document.getElementById('openCalendarModalBtn');
			const calendarModalOverlay = document.getElementById('calendarModalOverlay');
			const calendarModalCloseButton = document.getElementById('calendarModalCloseButton');
			const calendarModalTitle = document.getElementById('calendarModalTitle');
			const prevYearBtn = document.getElementById('prevYearBtn');
			const nextYearBtn = document.getElementById('nextYearBtn');
			const calendarYearSelect = document.getElementById('calendarYearSelect');
			const calendarGridContainer = document.getElementById('calendarGridContainer');
			const calendarModalErrorMessage = document.getElementById('calendarModalErrorMessage');

			const shamsiCalendarModalOverlay = document.getElementById('shamsiCalendarModalOverlay');
			const shamsiCalendarModalCloseButton = document.getElementById('shamsiCalendarModalCloseButton');
			const shamsiCalendarModalTitle = document.getElementById('shamsiCalendarModalTitle');
			const shamsiPrevYearBtn = document.getElementById('shamsiPrevYearBtn');
			const shamsiNextYearBtn = document.getElementById('shamsiNextYearBtn');
			const shamsiCalendarYearSelect = document.getElementById('shamsiCalendarYearSelect');
			const shamsiCalendarGridContainer = document.getElementById('shamsiCalendarGridContainer');
			const shamsiCalendarModalErrorMessage = document.getElementById('shamsiCalendarModalErrorMessage');


			let currentCalendarMode = 'shamsi';
			let currentCalendarYear = parseInt(hijriYearInput.value, 10);
			const minCalendarYear = 1277;
			const maxCalendarYear = 1361;
			const hijriMonthNames = ["محرم", "صفر", "ربیع‌الاول", "ربیع‌الثانی", "جمادی‌الاول", "جمادی‌الثانی", "رجب", "شعبان", "رمضان", "شوال", "ذی‌القعده", "ذی‌الحجه"];
			const shamsiMonthNames = ["فروردین", "اردیبهشت", "خرداد", "تیر", "مرداد", "شهریور", "مهر", "آبان", "آذر", "دی", "بهمن", "اسفند"];
			const availableHijriDates = new Map();
			const availableShamsiDates = new Map();

			let currentLightboxNewspaperId = null;
			let lightboxCurrentPage = 1;

			const newspaperConfigurations = {
				ettelaat: { type: 'formula', prefix: 'Ettelaat', title: 'اطلاعات', calendar_type: 'shamsi', firstIssueDate: "13050419" },
				mardom: { type: 'formula', prefix: 'Mardom', title: 'مردم', calendar_type: 'shamsi', firstIssueDate: "13571223" },
				kayhan: { type: 'formula', prefix: 'Kayhan', title: 'کیهان', calendar_type: 'shamsi', firstIssueDate: "13320525" },
				bakhtarEmrooz: { type: 'formula', prefix: 'BakhtarEmrooz', title: 'باختر امروز', calendar_type: 'shamsi', firstIssueDate: "13300329" },
				jashnShahanshahiIran: { type: 'formula', prefix: 'JashneShahanshahieIran', title: 'جشن شاهنشاهی ایران', calendar_type: 'shamsi', firstIssueDate: "13500503" },
				zaneRooz: { type: 'formula', prefix: 'ZaneRooz', title: 'زن روز', calendar_type: 'shamsi', firstIssueDate: "13461017" },
				babashamal: { type: 'formula', prefix: 'BabaShamal', title: 'باباشمل', calendar_type: 'shamsi', firstIssueDate: "13220125" },
				tamasha: { type: 'formula', prefix: 'Tamasha', title: 'تماشا', calendar_type: 'shamsi', firstIssueDate: "13491227" },
				yaghma: { type: 'formula', prefix: 'Yaghma', title: 'یغما', calendar_type: 'shamsi', firstIssueDate: "13270101" },
				negin: { type: 'formula', prefix: 'Negin', title: 'نگین', calendar_type: 'shamsi', firstIssueDate: "13440301" },
				jangal_qamari: { type: 'formula', prefix: 'Jangal', title: 'جنگل', calendar_type: 'hijri', firstIssueDate: "13350819" },
			};

			let newspaperData = {};

			function isShamsiLeapYear(year) {
				const rem = year % 33;
				return rem === 1 || rem === 5 || rem === 9 || rem === 13 || rem === 17 || rem === 22 || rem === 26 || rem === 30;
			}

			function shamsiDaysInMonth(year, month) {
				if (month >= 1 && month <= 6) return 31;
				if (month >= 7 && month <= 11) return 30;
				if (month === 12) return isShamsiLeapYear(year) ? 30 : 29;
				return 0;
			}

			function shamsiDateToDays(year, month, day) {
				let totalDays = 0;
				for (let y = 1; y < year; y++) {
					totalDays += isShamsiLeapYear(y) ? 366 : 365;
				}
				for (let m = 1; m < month; m++) {
					totalDays += shamsiDaysInMonth(year, m);
				}
				totalDays += day;
				return totalDays;
			}

			const populateDateDropdowns = () => {
				for (let year = 1305; year <= 1373; year++) {
					const option = new Option(englishToPersianDigits(year), year);
					shamsiYearInput.add(option);
					shamsiCalendarYearSelect.add(option.cloneNode(true));
				}
				shamsiYearInput.value = "1350";
				shamsiCalendarYearSelect.value = "1350";

				for (let year = 1277; year <= 1361; year++) {
					const option = new Option(englishToPersianDigits(year), year);
					hijriYearInput.add(option);
				}
				hijriYearInput.value = "1325";

				for (let day = 1; day <= 31; day++) {
					const option = new Option(englishToPersianDigits(day), day);
					shamsiDayInput.add(option);
					hijriDayInput.add(option.cloneNode(true));
				}
				shamsiDayInput.value = "4";
				hijriDayInput.value = "21";
			};

			const generateNewspaperSectionsAndButtons = () => {
				Object.keys(newspaperConfigurations).forEach(id => {
					const config = newspaperConfigurations[id];

					const sectionDiv = document.createElement('div');
					sectionDiv.id = `${id}Section`;
					sectionDiv.classList.add('newspaper-section');
					sectionDiv.style.display = 'none';

					sectionDiv.innerHTML = `
						<h2>${config.title}</h2>
						<div class="image-container" id="${id}ImageContainer">
							<img id="${id}NewspaperImage" src="" alt="تصویر ${config.title}" class="newspaper-image" style="display:none;">
							<div id="${id}ImagePlaceholder" class="image-placeholder" style="display:none;">تصویر در دسترس نیست</div>
						</div>
						<p id="${id}StatusMessage" class="status-message" style="display: none;"></p>
						<p id="${id}ErrorMessage" class="error-message" style="display: none;"></p>
						<div id="${id}Navigation" class="issue-navigation-controls" style="display: none;">
							<div>
								<button id="prev${id}Issue">&lt; شماره قبل</button>
								<div>
									<span>شماره:</span>
									<input type="number" id="${id}IssueNumber">
								</div>
								<button id="next${id}Issue">شماره بعد &gt;</button>
							</div>
						</div>
						<button class="view-all-issues-btn" data-newspaper-id="${id}" style="display: none;">مشاهده تمام شماره‌ها</button>
					`;
					newspaperContainer.appendChild(sectionDiv);

					const firstIssueBtn = document.createElement('button');
					firstIssueBtn.id = `goToFirst${id.charAt(0).toUpperCase() + id.slice(1)}Global`;
					firstIssueBtn.textContent = config.title;
					firstIssueBtn.style.display = 'none';
					firstIssueBtn.classList.add(config.calendar_type === 'shamsi' ? 'shamsi-nav-btn' : 'hijri-nav-btn');

					newspaperData[id] = {
						id: id,
						type: config.type,
						prefix: config.prefix,
						title: config.title,
						currentPage: 1,
						available: false,
						hasImage: false,
						imageElement: document.getElementById(`${id}NewspaperImage`),
						imagePlaceholderElement: document.getElementById(`${id}ImagePlaceholder`),
						sectionElement: document.getElementById(`${id}Section`),
						statusElement: document.getElementById(`${id}StatusMessage`),
						errorElement: document.getElementById(`${id}ErrorMessage`),
						calendar_type: config.calendar_type,
						firstIssueDate: config.firstIssueDate,
						globalFirstIssueBtn: firstIssueBtn,
						currentIssue: null,
						fileNameBase: null,
						maxPages: null,
						frequency: config.frequency || 'daily',
					};

					newspaperData[id].navState = {
						issuesArray: [],
						currentIndex: -1,
						prevIssueBtn: document.getElementById(`prev${id}Issue`),
						nextIssueBtn: document.getElementById(`next${id}Issue`),
						issueNumberInput: document.getElementById(`${id}IssueNumber`),
						navigationDiv: document.getElementById(`${id}Navigation`)
					};
					newspaperData[id].viewAllIssuesBtn = sectionDiv.querySelector('.view-all-issues-btn');

				});
			};

			const loadNewspaperDbData = async () => {
				try {
					const response = await fetch('db.json');
					if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
					const dbNewspapersRawData = await response.json();
					console.log("db.json loaded successfully.");

					dbNewspapersRawData.forEach(dbPaper => {
						const paperId = dbPaper.id;

						let calculatedFirstIssueDate = null;
						let sortedIssues = [];
						if (dbPaper.issues && dbPaper.issues.length > 0) {
							if (dbPaper.source === 'utlib') {
								sortedIssues = [...dbPaper.issues].sort((a, b) => {
                                    if (dbPaper.calendar_type === 'hijri' && a.year_hijri !== undefined && b.year_hijri !== undefined) {
                                        if (a.year_hijri !== b.year_hijri) return a.year_hijri - b.year_hijri;
                                    } else if (a.year_shamsi !== undefined && b.year_shamsi !== undefined) {
                                        if (a.year_shamsi !== b.year_shamsi) return a.year_shamsi - b.year_shamsi;
                                    }

									if (a.volume !== b.volume) return a.volume - b.volume;

									const numA = a.number === null ? -Infinity : a.number;
									const numB = b.number === null ? -Infinity : b.number;
									return numA - numB;
								});
								if (sortedIssues.length > 0) {
                                    if (dbPaper.calendar_type === 'hijri' && sortedIssues[0].year_hijri !== undefined) {
                                        calculatedFirstIssueDate = `${sortedIssues[0].year_hijri}0101`;
                                    } else {
                                        calculatedFirstIssueDate = `${sortedIssues[0].year_shamsi}0101`;
                                    }
								}
							} else {
								sortedIssues = [...dbPaper.issues].sort((a, b) => {
									const dateA = parseInt(a.date, 10);
									const dateB = parseInt(b.date, 10);
									return dateA - dateB;
								});
								const firstIssue = sortedIssues[0];
								calculatedFirstIssueDate = firstIssue.date;
							}
						}

						if (!newspaperConfigurations[paperId]) {
							newspaperConfigurations[paperId] = {
								type: 'database',
								title: dbPaper.title.replace(/^روزنامه\s*/, '').replace(/^نشريه\s*/, ''),
								calendar_type: dbPaper.calendar_type,
								frequency: dbPaper.frequency || 'daily',
								source: dbPaper.source || 'wikimedia'
							};

							const sectionDiv = document.createElement('div');
							sectionDiv.id = `${paperId}Section`;
							sectionDiv.classList.add('newspaper-section');
							sectionDiv.style.display = 'none';

							sectionDiv.innerHTML = `
								<h2>${newspaperConfigurations[paperId].title}</h2>
								<div class="image-container" id="${paperId}ImageContainer">
									<img id="${paperId}NewspaperImage" src="" alt="تصویر ${newspaperConfigurations[paperId].title}" class="newspaper-image" style="display:none;">
									<div id="${paperId}ImagePlaceholder" class="image-placeholder" style="display:none;">تصویر در دسترس نیست</div>
								</div>
								<p id="${paperId}StatusMessage" class="status-message" style="display: none;"></p>
								<p id="${paperId}ErrorMessage" class="error-message" style="display: none;"></p>
								<div id="${paperId}Navigation" class="issue-navigation-controls" style="display: none;">
									<div>
										<button id="prev${paperId}Issue">&lt; شماره قبل</button>
										<div>
											<span>شماره:</span>
											<input type="number" id="${paperId}IssueNumber">
										</div>
										<button id="next${paperId}Issue">شماره بعد &gt;</button>
								</div>
							</div>
							<button class="view-all-issues-btn" data-newspaper-id="${paperId}" style="display: none;">مشاهده تمام شماره‌ها</button>
						`;
							newspaperContainer.appendChild(sectionDiv);

							const firstIssueBtn = document.createElement('button');
							firstIssueBtn.id = `goToFirst${paperId}Global`;
							firstIssueBtn.textContent = newspaperConfigurations[paperId].title;
							firstIssueBtn.style.display = 'none';
							firstIssueBtn.classList.add(newspaperConfigurations[paperId].calendar_type === 'shamsi' ? 'shamsi-nav-btn' : 'hijri-nav-btn');

							newspaperData[paperId] = {
								id: paperId,
								type: 'database',
								title: newspaperConfigurations[paperId].title,
								currentPage: 1,
								available: false,
								hasImage: false,
								imageElement: document.getElementById(`${paperId}NewspaperImage`),
								imagePlaceholderElement: document.getElementById(`${paperId}ImagePlaceholder`),
								sectionElement: document.getElementById(`${paperId}Section`),
								statusElement: document.getElementById(`${paperId}StatusMessage`),
								errorElement: document.getElementById(`${paperId}ErrorMessage`),
								calendar_type: newspaperConfigurations[paperId].calendar_type,
								globalFirstIssueBtn: firstIssueBtn,
								viewAllIssuesBtn: sectionDiv.querySelector('.view-all-issues-btn'),
								currentIssue: null,
								fileNameBase: null,
								maxPages: null,
								frequency: dbPaper.frequency || 'daily',
								source: dbPaper.source || 'wikimedia'
							};
						} else {
							newspaperData[paperId].source = dbPaper.source || 'wikimedia';
						}

						newspaperData[paperId].firstIssueDate = calculatedFirstIssueDate;
						newspaperData[paperId].issues = dbPaper.issues;
						
						newspaperData[paperId].navState = {
							issuesArray: sortedIssues,
							currentIndex: -1,
							prevIssueBtn: document.getElementById(`prev${paperId}Issue`),
							nextIssueBtn: document.getElementById(`next${paperId}Issue`),
							issueNumberInput: document.getElementById(`${paperId}IssueNumber`),
							navigationDiv: document.getElementById(`${paperId}Navigation`)
						};

						const navState = newspaperData[paperId].navState;
						if (navState.prevIssueBtn) navState.prevIssueBtn.addEventListener('click', () => goToPrevNewspaperIssue(paperId));
						if (navState.nextIssueBtn) navState.nextIssueBtn.addEventListener('click', () => goToNextNewspaperIssue(paperId));
						if (navState.issueNumberInput) navState.issueNumberInput.addEventListener('change', () => goToNewspaperIssueByNumber(paperId));

						if (dbPaper.calendar_type === 'hijri') {
							dbPaper.issues.forEach(issue => {
								if (issue.date) {
									availableHijriDates.set(issue.date, (availableHijriDates.get(issue.date) || 0) + 1);
								}
							});
						} else if (dbPaper.calendar_type === 'shamsi') {
							dbPaper.issues.forEach(issue => {
								if (issue.date) {
									availableShamsiDates.set(issue.date, (availableShamsiDates.get(issue.date) || 0) + 1);
								}
							});
						}
					});

					Object.values(newspaperData).forEach(paper => {
						if (paper.globalFirstIssueBtn) {
							paper.globalFirstIssueBtn.addEventListener('click', () => handleGlobalGoToFirstIssue(paper.id));
						}
						if (paper.viewAllIssuesBtn) {
							paper.viewAllIssuesBtn.addEventListener('click', () => openAllNewspapersIssuesModal(paper.id));
						}
						const imageContainer = paper.sectionElement.querySelector('.image-container');
						if (imageContainer) {
							imageContainer.addEventListener('click', () => openLightbox(paper.id));
						}
					});

				} catch (error) {
					console.error("Error loading db.json:", error);
					mainErrorMessage.textContent = "خطا در بارگذاری دیتابیس نشریات.";
					mainErrorMessage.style.display = 'block';
					mainStatusMessage.style.display = 'none';
				}
			};

			const sortAndRenderGlobalFirstIssueButtons = () => {
				const allPapers = Object.values(newspaperData);
				const sortablePapers = allPapers.filter(paper => paper.firstIssueDate);

				const shamsiPapers = sortablePapers.filter(p => p.calendar_type === 'shamsi');
				const hijriPapers = sortablePapers.filter(p => p.calendar_type === 'hijri');

				const shamsiNewspaperCount = shamsiPapers.length;
				const shamsiIssueCount = shamsiPapers.reduce((sum, paper) => sum + (paper.navState.issuesArray?.length || 0), 0);

				const hijriNewspaperCount = hijriPapers.length;
				const hijriIssueCount = hijriPapers.reduce((sum, paper) => sum + (paper.navState.issuesArray?.length || 0), 0);

				shamsiPapers.sort((a, b) => {
					const yearA = parseInt(a.firstIssueDate.substring(0, 4), 10);
					const yearB = parseInt(b.firstIssueDate.substring(0, 4), 10);
					if (yearA !== yearB) return yearA - yearB;
					return a.title.localeCompare(b.title, 'fa');
				});

				hijriPapers.sort((a, b) => {
					const dateA = parseInt(a.firstIssueDate, 10);
					const dateB = parseInt(b.firstIssueDate, 10);
					if (dateA !== dateB) return dateA - dateB;
					return a.title.localeCompare(b.title, 'fa');
				});

				globalGoToFirstIssueControls.innerHTML = '';

				if (hijriPapers.length > 0) {
					const heading = document.createElement('h3');
					heading.style.width = '100%';
					heading.style.textAlign = 'center';
					heading.style.marginTop = '15px';
					heading.style.marginBottom = '5px';
					heading.style.color = 'var(--section-title-color)';
					heading.style.fontSize = '1.1em';
					heading.textContent = `نشریات قمری (${englishToPersianDigits(hijriNewspaperCount)} نشریه، ${englishToPersianDigits(hijriIssueCount)} شمارهٔ نمایه‌شده)`;
					globalGoToFirstIssueControls.appendChild(heading);
					hijriPapers.forEach(paper => {
						if (paper.globalFirstIssueBtn) {
							globalGoToFirstIssueControls.appendChild(paper.globalFirstIssueBtn);
							paper.globalFirstIssueBtn.style.display = 'inline-block';
						}
					});
				}

				if (shamsiPapers.length > 0) {
					const heading = document.createElement('h3');
					heading.style.width = '100%';
					heading.style.textAlign = 'center';
					heading.style.marginTop = '15px';
					heading.style.marginBottom = '5px';
					heading.style.color = 'var(--section-title-color)';
					heading.style.fontSize = '1.1em';
					heading.textContent = `نشریات شمسی (${englishToPersianDigits(shamsiNewspaperCount)} نشریه، ${englishToPersianDigits(shamsiIssueCount)} شمارهٔ نمایه‌شده)`;
					globalGoToFirstIssueControls.appendChild(heading);
					shamsiPapers.forEach(paper => {
						if (paper.globalFirstIssueBtn) {
							globalGoToFirstIssueControls.appendChild(paper.globalFirstIssueBtn);
							paper.globalFirstIssueBtn.style.display = 'inline-block';
						}
					});
				}
			};


			const initializeApp = async () => {
				populateDateDropdowns();

				generateNewspaperSectionsAndButtons();

				await loadNewspaperDbData();

				sortAndRenderGlobalFirstIssueButtons();

				setShowDatesCheckboxDefault();
				setShowImagesCheckboxDefault();

				const urlCalendar = getUrlParameter('calendar');
				const urlYear = getUrlParameter('year');
				const urlMonth = getUrlParameter('month');
				const urlDay = getUrlParameter('day');

				if (urlCalendar && urlYear && urlMonth && urlDay) {
					if (urlCalendar === 'shamsi') {
						shamsiCalendarRadio.checked = true;
						currentCalendarMode = 'shamsi';
						handleCalendarChange({
							year: urlYear,
							month: urlMonth,
							day: urlDay
						});
					} else if (urlCalendar === 'hijri') {
						hijriCalendarRadio.checked = true;
						currentCalendarMode = 'hijri';
						handleCalendarChange({
							year: urlYear,
							month: urlMonth,
							day: urlDay
						});
					}
				} else {
					loadImage('initial');
				}
				updateGlobalGoToFirstIssueButtonsVisibility();
			};

			const getWikimediaHash = (paper, fullFileNameWithPdf) => {
				if (paper.type === 'database' && paper.currentIssue && paper.currentIssue.wikimedia_hash) {
					return paper.currentIssue.wikimedia_hash;
				}
				const filenameForHash = fullFileNameWithPdf.replace(/ /g, '_');
				const fullMd5 = MD5(filenameForHash);
				return fullMd5.substring(0, 2);
			};

			const getIssueFileUrl = (paper, issue, page = 1, width = 800) => {
				if (paper.source === 'utlib') {
					if (issue && issue.file_id) {
						return `https://lib.ut.ac.ir/multiMediaFile/${issue.file_id}.pdf`;
					}
					return null;
				} else {
                    const baseFileName = paper.fileNameBase || (issue ? issue.filename_base : null);
                    if (!baseFileName) {
                        console.error("Missing base filename for non-utlib paper:", paper.id, issue);
                        return null;
                    }
					const fullFileNameWithPdf = `${baseFileName}.pdf`;
					const hash = getWikimediaHash(paper, fullFileNameWithPdf);
					const fileNameForUrlPath = fullFileNameWithPdf.replace(/ /g, '_');
					return `https://upload.wikimedia.org/wikipedia/commons/thumb/${hash[0]}/${hash}/${fileNameForUrlPath}/page${page}-${width}px-${fileNameForUrlPath}.jpg`;
				}
			};

			const checkAndLoadNewspaper = async (id, year, month, day, page) => {
				const paper = newspaperData[id];
				if (!paper || !paper.sectionElement) {
					console.warn(`Newspaper data or sectionElement missing for ID: ${id}`);
					return Promise.resolve(false);
				}

				let fileNameBase;
				let maxPages = null;
				let shouldDisplaySectionBasedOnModeAndType = false;
				let issueExistsForDate = false;
				let foundIssueForDate = null;

				if (currentCalendarMode === 'hijri') {
					if (paper.calendar_type === 'hijri') {
						shouldDisplaySectionBasedOnModeAndType = true;
					}
				} else {
					if (paper.calendar_type === 'shamsi') {
						shouldDisplaySectionBasedOnModeAndType = true;
					}
				}

				if (paper.viewAllIssuesBtn) {
					if (paper.type === 'database' && paper.issues && paper.issues.length > 0 && shouldDisplaySectionBasedOnModeAndType) {
						paper.viewAllIssuesBtn.style.display = 'block';
					} else {
						paper.viewAllIssuesBtn.style.display = 'none';
					}
				}

				const titleElement = paper.sectionElement.querySelector('h2');
				if (titleElement) {
					titleElement.textContent = paper.title;
				}

				paper.sectionElement.style.display = shouldDisplaySectionBasedOnModeAndType ? 'flex' : 'none';
				if (!shouldDisplaySectionBasedOnModeAndType) {
					paper.available = false;
					paper.hasImage = false;
					if (paper.navState && paper.navState.navigationDiv) {
						paper.navState.navigationDiv.style.display = 'none';
					}
					return Promise.resolve(false);
				}

				paper.errorElement.style.display = 'none';
				paper.statusElement.style.display = 'none';
				
				if (paper.type === 'formula') {
					if (id === 'jangal_qamari') {
						fileNameBase = `${paper.prefix} ${year}${month}${day} AH`;
						issueExistsForDate = true;
					} else if (id === 'yaghma' && paper.calendar_type === 'shamsi') {
						const shamsiInputYear = parseInt(year, 10);
						const shamsiInputMonth = parseInt(month, 10);
						if (shamsiInputYear >= 1327 && shamsiInputYear <= 1357 && shamsiInputMonth >= 1 && shamsiInputMonth <= 12) {
							const volume = shamsiInputYear - 1327 + 1;
							const issueNumber = shamsiInputMonth;
							fileNameBase = `Yaghma, Vol. ${volume}, No. ${issueNumber}, ${shamsiInputYear} SH`;
							issueExistsForDate = true;
						} else {
							paper.errorElement.textContent = 'نشریه یغما در این تاریخ (سال/ماه) موجود نیست.';
							paper.errorElement.style.display = 'block';
							paper.available = false;
							paper.hasImage = false;
							return Promise.resolve(false);
						}
					} else if (id === 'negin' && paper.calendar_type === 'shamsi') {
						const shamsiInputYear = parseInt(year, 10);
						const shamsiInputMonth = parseInt(month, 10);
						const startDateCheck = shamsiInputYear > 1344 || (shamsiInputYear === 1344 && shamsiInputMonth >= 3);
						const endDateCheck = shamsiInputYear < 1359 || (shamsiInputYear === 1359 && shamsiInputMonth <= 1);
						if (startDateCheck && endDateCheck) {
							const volume = shamsiInputYear - 1344 + 1;
							let issueNumber;
							if (shamsiInputYear === 1344) {
								issueNumber = shamsiInputMonth - 2;
							} else {
								const yearsAfter1344 = shamsiInputYear - 1345;
								const issuesInFullYears = yearsAfter1344 * 12;
								issueNumber = 10 + issuesInFullYears + shamsiInputMonth;
							}
							fileNameBase = `Negin, Vol. ${volume}, No. ${issueNumber}, ${shamsiInputYear} SH`;
							issueExistsForDate = true;
						} else {
							paper.errorElement.textContent = 'نشریه نگین در این تاریخ (سال/ماه) موجود نیست.';
							paper.errorElement.style.display = 'block';
							paper.available = false;
							paper.hasImage = false;
							return Promise.resolve(false);
						}
					} else {
						fileNameBase = `${paper.prefix}${year}${month}${day}${paper.calendar_type === 'hijri' ? ' AH' : ''}`;
						issueExistsForDate = true;
					}
					paper.currentIssue = null;
                    paper.fileNameBase = fileNameBase;
				} else if (paper.type === 'database') {
					const selectedDateShamsi = { year: parseInt(year), month: parseInt(month), day: parseInt(day) };
					let selectedDateDays = null;
					if (paper.calendar_type === 'shamsi') {
						selectedDateDays = shamsiDateToDays(selectedDateShamsi.year, selectedDateShamsi.month, selectedDateShamsi.day);
					}
					
					// Special logic for UTLib papers without exact date
					if (paper.source === 'utlib' && paper.calendar_type === 'shamsi') {
						foundIssueForDate = paper.issues.find(issue => issue.year_shamsi == selectedDateShamsi.year);
					} else {
						foundIssueForDate = paper.issues.find(issue => {
							const issueDateParsed = parseDateString(issue.date);
							if (!issueDateParsed) return false;
							if (paper.calendar_type === 'shamsi') {
								const issueDateShamsi = { year: issueDateParsed.year, month: issueDateParsed.month, day: issueDateParsed.day };
								const issueDateDays = shamsiDateToDays(issueDateShamsi.year, issueDateShamsi.month, issueDateShamsi.day);
								if (paper.frequency === 'daily') {
									return (selectedDateShamsi.year === issueDateShamsi.year && selectedDateShamsi.month === issueDateShamsi.month && selectedDateShamsi.day === issueDateShamsi.day);
								} else if (paper.frequency === 'monthly') {
									return (selectedDateShamsi.year === issueDateShamsi.year && selectedDateShamsi.month === issueDateShamsi.month);
								}
							} else if (paper.calendar_type === 'hijri') {
								return (selectedDateShamsi.year === issueDateParsed.year && selectedDateShamsi.month === issueDateParsed.month && selectedDateShamsi.day === issueDateParsed.day);
							}
							return false;
						});
					}

					if (foundIssueForDate) {
						fileNameBase = foundIssueForDate.filename_base;
						maxPages = foundIssueForDate.pages || null;
						paper.currentIssue = foundIssueForDate;
						issueExistsForDate = true;

						if (paper.navState) {
							paper.navState.currentIndex = paper.navState.issuesArray.findIndex(issue =>
								(issue.filename_base && foundIssueForDate.filename_base && issue.filename_base === foundIssueForDate.filename_base) ||
								(issue.file_id && foundIssueForDate.file_id && issue.file_id === foundIssueForDate.file_id)
							);
						}

						if (titleElement) {
							let baseTitle = paper.title;
							if (foundIssueForDate.issue_number) {
								titleText = `${baseTitle} (شماره ${englishToPersianDigits(foundIssueForDate.issue_number)})`;
								titleElement.textContent = titleText;
							} else {
								titleElement.textContent = baseTitle;
							}
						}

					} else {
						paper.errorElement.textContent = 'نشریه در این تاریخ موجود نیست';
						paper.errorElement.style.display = 'block';
						paper.available = false;
						paper.hasImage = false;
						if (titleElement) {
							titleElement.textContent = paper.title;
						}
						if (paper.navState && paper.navState.navigationDiv) {
							paper.navState.navigationDiv.style.display = 'none';
						}
						return Promise.resolve(false);
					}
				} else {
					console.warn("Unknown paper type for:", id);
					return Promise.resolve(false);
				}

				if (!issueExistsForDate) {
					paper.available = false;
					paper.hasImage = false;
					if (paper.navState && paper.navState.navigationDiv) {
						paper.navState.navigationDiv.style.display = 'none';
					}
					return Promise.resolve(false);
				}

				paper.statusElement.textContent = 'در حال بارگذاری...';
				paper.statusElement.style.display = 'block';

				const imageUrl = getIssueFileUrl(paper, paper.currentIssue, page, 330);

				return new Promise((resolve, reject) => {
					const imageContainer = paper.sectionElement.querySelector('.image-container');
					imageContainer.style.cursor = 'pointer';

					if (paper.source === 'utlib' && paper.currentIssue) {
						const downloadUrl = getIssueFileUrl(paper, paper.currentIssue);

						imageContainer.innerHTML = `<a href="${downloadUrl}" target="_blank" class="utlib-download-link">دانلود PDF</a>`;
						paper.sectionElement.classList.add('no-image');

						paper.statusElement.style.display = 'none';
						paper.errorElement.style.display = 'none';
						paper.available = true;
						paper.hasImage = false;
						if (paper.navState) {
							updateIssueNavigationVisibility(id);
						}
						resolve(true);
						return;
					}
					
					imageContainer.innerHTML = `<img id="${id}NewspaperImage" src="" alt="تصویر ${paper.title}" class="newspaper-image" style="display:none;">`;
					paper.imageElement = document.getElementById(`${id}NewspaperImage`);
					paper.imageElement.src = imageUrl;
					paper.sectionElement.classList.remove('no-image');


					paper.imageElement.onload = () => {
						paper.statusElement.style.display = 'none';
						paper.imageElement.style.display = 'block';
						paper.errorElement.style.display = 'none';
						paper.available = true;
						paper.hasImage = true;
						if (paper.navState) {
							updateIssueNavigationVisibility(id);
						}
						paper.fileNameBase = fileNameBase;
						paper.maxPages = maxPages;
						resolve(true);
					};
					paper.imageElement.onerror = () => {
						paper.statusElement.style.display = 'none';
						paper.imageElement.style.display = 'none';
						const placeholder = document.createElement('div');
						placeholder.classList.add('image-placeholder');
						placeholder.textContent = 'تصویر در دسترس نیست';
						document.getElementById(`${id}ImageContainer`).appendChild(placeholder);
						paper.errorElement.textContent = 'تصویر اصلی یافت نشد.';
						paper.errorElement.style.display = 'block';
						paper.available = true;
						paper.hasImage = false;
						paper.sectionElement.classList.add('no-image');
						if (paper.navState) {
							updateIssueNavigationVisibility(id);
						}
						resolve(true);
					};
				});
			};

			const loadImage = async (source = 'initial') => {
				let year, month, day;

				if (currentCalendarMode === 'shamsi') {
					year = shamsiYearInput.value;
					month = pad(shamsiMonthSelect.value);
					day = pad(shamsiDayInput.value);
				} else {
					year = hijriYearInput.value;
					month = pad(hijriMonthSelect.value);
					day = pad(hijriDayInput.value);
				}

				let targetPage = parseInt(persianToEnglishDigits(mainPageNumberInput.value), 10);
				if (isNaN(targetPage) || targetPage < 1) {
					targetPage = 1;
				}

				if (source === 'date') {
					targetPage = 1;
					mainPageNumberInput.value = targetPage;
					Object.values(newspaperData).forEach(paper => {
						if(paper) paper.currentPage = targetPage;
					});
					mainStatusMessage.textContent = 'در حال بارگذاری نشریات...';
					mainStatusMessage.style.display = 'block';
					mainErrorMessage.style.display = 'none';
				} else if (source === 'pageInput') {
					Object.values(newspaperData).forEach(paper => {
						if(paper) paper.currentPage = targetPage;
					});
				}

				if (!year || !month || !day) {
					mainErrorMessage.textContent = 'لطفا تاریخ کامل را وارد کنید.';
					mainErrorMessage.style.display = 'block';
					mainStatusMessage.style.display = 'none';
					Object.values(newspaperData).forEach(paper => {
						if(paper && paper.sectionElement) paper.sectionElement.style.display = 'none';
						if(paper && paper.navState && paper.navState.navigationDiv) {
							paper.navState.navigationDiv.style.display = 'none';
						}
					});
					return;
				}

				if (source !== 'date') {
					mainErrorMessage.style.display = 'none';
					if (mainStatusMessage.style.display === 'none') {
						mainStatusMessage.textContent = 'در حال بارگذاری نشریات...';
						mainStatusMessage.style.display = 'block';
					}
				}

				Object.values(newspaperData).forEach(paper => {
					if (paper) {
						paper.available = false;
						paper.hasImage = false;
						if (paper.navState && paper.navState.navigationDiv) {
							paper.navState.navigationDiv.style.display = 'none';
						}
					}
				});

				const loadPromises = Object.keys(newspaperData).map(id =>
					checkAndLoadNewspaper(id, year, month, day, newspaperData[id] ? newspaperData[id].currentPage : 1)
				);
				const results = await Promise.all(loadPromises.map(p => p.catch(e => e)));
				mainStatusMessage.style.display = 'none';

				const newspaperKeys = Object.keys(newspaperData);
				const frequencyOrder = { 'daily': 1, 'weekly': 2, 'monthly': 3, 'quarterly': 4, 'yearly': 5 };

				newspaperKeys.sort((aKey, bKey) => {
					const paperA = newspaperData[aKey];
					const paperB = newspaperData[bKey];

					if (!paperA || !paperB) return 0;

					if (paperA.hasImage && !paperB.hasImage) return -1;
					if (!paperA.hasImage && paperB.hasImage) return 1;

					if (paperA.available && !paperB.available) return -1;
					if (!paperA.available && paperB.available) return 1;

					const aMatchesMode = (currentCalendarMode === 'shamsi' && paperA.calendar_type === 'shamsi') ||
										(currentCalendarMode === 'hijri' && paperA.calendar_type === 'hijri');
					const bMatchesMode = (currentCalendarMode === 'shamsi' && paperB.calendar_type === 'shamsi') ||
										(currentCalendarMode === 'hijri' && paperB.calendar_type === 'hijri');

					if (aMatchesMode && !bMatchesMode) return -1;
					if (!aMatchesMode && bMatchesMode) return 1;

					const freqA = frequencyOrder[paperA.frequency] || 99;
					const freqB = frequencyOrder[paperB.frequency] || 99;
					if (freqA !== freqB) return freqA - freqB;

					return paperA.title.localeCompare(paperB.title, 'fa');
				});

				while (newspaperContainer.firstChild) {
					newspaperContainer.removeChild(newspaperContainer.firstChild);
				}

				newspaperKeys.forEach(key => {
					const paper = newspaperData[key];
					if (paper && paper.sectionElement) {
						let displayThisInContainer = paper.available &&
							((currentCalendarMode === 'hijri' && paper.calendar_type === 'hijri') ||
							 (currentCalendarMode === 'shamsi' && paper.calendar_type === 'shamsi'));

						paper.sectionElement.style.display = displayThisInContainer ? 'flex' : 'none';
						if (displayThisInContainer) {
							newspaperContainer.appendChild(paper.sectionElement);
						}
					}
				});

				Object.keys(newspaperData).forEach(paperId => {
					if (newspaperData[paperId] && newspaperData[paperId].navState) {
						updateIssueNavigationVisibility(paperId);
					}
				});
				updateGlobalGoToFirstIssueButtonsVisibility();

				if (!results.some(loaded => loaded) && (currentCalendarMode === 'shamsi' || currentCalendarMode === 'hijri')) {
					mainErrorMessage.textContent = 'نشریه‌ای برای این تاریخ یافت نشد.';
					mainErrorMessage.style.display = 'block';
				} else {
					mainErrorMessage.style.display = 'none';
				}
			};

			const handleCalendarChange = (targetDate = null) => {
				shamsiDateControls.style.display = currentCalendarMode === 'shamsi' ? 'block' : 'none';
				hijriDateControls.style.display = currentCalendarMode === 'hijri' ? 'block' : 'none';

				if (targetDate) {
					if (currentCalendarMode === 'shamsi') {
						shamsiYearInput.value = targetDate.year;
						shamsiMonthSelect.value = targetDate.month;
						shamsiDayInput.value = targetDate.day;
					} else if (targetDate.calendar_type === 'hijri') {
						hijriYearInput.value = targetDate.year;
						hijriMonthSelect.value = targetDate.month;
						hijriDayInput.value = targetDate.day;
					}
					mainPageNumberInput.value = 1;
					Object.values(newspaperData).forEach(p => { if(p) p.currentPage = 1; });
				}

				if (currentCalendarMode === 'shamsi') {
					updateUrlParameters(
						'shamsi',
						shamsiYearInput.value,
						shamsiMonthSelect.value,
						shamsiDayInput.value
					);
				} else {
					updateUrlParameters(
						'hijri',
						hijriYearInput.value,
						hijriMonthSelect.value,
						hijriDayInput.value
					);
				}

				loadImage('date');
			};

			const openLightbox = async (id) => {
				currentLightboxNewspaperId = id;
				const paper = newspaperData[id];
				if (!paper || !paper.available) {
					console.warn(`Lightbox cannot be opened for ${id} as it's not available for the selected date.`);
					return;
				}
				lightboxCurrentPage = paper.currentPage;
				lightboxOverlay.classList.add('visible');
				await updateLightboxContent();
			};

			const closeLightbox = () => {
					if (currentLightboxNewspaperId && newspaperData[currentLightboxNewspaperId]) {
							newspaperData[currentLightboxNewspaperId].currentPage = 1;
					}
					lightboxOverlay.classList.remove('visible');
					currentLightboxNewspaperId = null;
			};


			const updateLightboxContent = async () => {
				const id = currentLightboxNewspaperId;
				if (!id || !newspaperData[id]) {
					closeLightbox();
					return;
				}

				const paper = newspaperData[id];
				let year, month, day;
				lightboxImagePlaceholder.style.display = 'none';

				if (currentCalendarMode === 'shamsi') {
					year = shamsiYearInput.value;
					month = pad(shamsiMonthSelect.value);
					day = pad(shamsiDayInput.value);
				} else {
					year = hijriYearInput.value;
					month = pad(hijriMonthSelect.value);
					day = pad(hijriDayInput.value);
				}

				let formattedDate;

				if (paper.source === 'utlib') {
					if (!paper.currentIssue) {
						lightboxStatusMessage.style.display = 'none';
						lightboxErrorMessage.textContent = `اطلاعات شماره برای ${paper.title} در لایت‌باکس یافت نشد.`;
						lightboxErrorMessage.style.display = 'block';
						return;
					}
                    let displayYearLightbox = '';
                    if (paper.calendar_type === 'hijri' && paper.currentIssue.year_hijri !== undefined) {
                        displayYearLightbox = englishToPersianDigits(paper.currentIssue.year_hijri);
                    } else {
                        displayYearLightbox = englishToPersianDigits(paper.currentIssue.year_shamsi);
                    }
					lightboxNewspaperTitle.textContent = `${paper.title} - سال: ${displayYearLightbox}${paper.currentIssue.volume ? `, دوره: ${englishToPersianDigits(paper.currentIssue.volume)}` : ''}${paper.currentIssue.number ? `, شماره: ${englishToPersianDigits(paper.currentIssue.number)}` : ''}`;
					lightboxPageNumberInput.value = '1';
					lightboxImage.alt = `پیش‌نمایش برای ${paper.title} موجود نیست.`;
					lightboxImage.style.display = 'none';
					lightboxImagePlaceholder.style.display = 'flex';
					lightboxImage.onclick = null;

					downloadLink.href = getIssueFileUrl(paper, paper.currentIssue);
					downloadLink.textContent = 'دانلود PDF';
					downloadLink.style.display = 'inline-block';

					viewLargeLink.style.display = 'none';

					lightboxPrevPageButton.disabled = true;
					lightboxNextPageButton.disabled = true;
					lightboxPageNumberInput.disabled = true;

					lightboxStatusMessage.style.display = 'none';
					lightboxErrorMessage.style.display = 'none';
				} else {
					let displayDayForDate = (id === 'yaghma' || id === 'negin') && paper.calendar_type === 'shamsi' ? '01' : day;

					if (paper.type === 'database' && paper.currentIssue) {
						const issueDateParsed = parseDateString(paper.currentIssue.date);
						if (issueDateParsed) {
							year = issueDateParsed.year;
							month = issueDateParsed.month;
							day = issueDateParsed.day;
						}
					}

					if (paper.calendar_type === 'hijri') {
						const hijriMonthName = hijriMonthNames[month - 1];
						formattedDate = `${englishToPersianDigits(pad(day))} ${hijriMonthName} ${englishToPersianDigits(year)} (قمری)`;
					} else if (paper.calendar_type === 'shamsi') {
						const persianMonthName = shamsiMonthNames[month - 1];

						if (paper.type === 'database' && paper.frequency === 'monthly') {
							formattedDate = `${persianMonthName} ${englishToPersianDigits(year)}`;
						} else {
							formattedDate = `${englishToPersianDigits(pad(day))} ${persianMonthName} ${englishToPersianDigits(year)}`;
						}
					} else {
						formattedDate = `${englishToPersianDigits(pad(day))}/${englishToPersianDigits(pad(month))}/${englishToPersianDigits(year)}`;
					}

					let titleText = `${paper.title}`;
					if (paper.type === 'database' && paper.currentIssue && paper.currentIssue.issue_number) {
						titleText += ` (شماره ${englishToPersianDigits(paper.currentIssue.issue_number)})`;
					}

					lightboxNewspaperTitle.textContent = `${titleText} - ${formattedDate} - صفحه: ${englishToPersianDigits(lightboxCurrentPage)}`;
					lightboxPageNumberInput.value = lightboxCurrentPage;
					lightboxImage.alt = `تصویر ${paper.title} در لایت‌باکس - صفحه ${englishToPersianDigits(lightboxCurrentPage)}`;

					lightboxStatusMessage.textContent = 'در حال بارگذاری...';
					lightboxStatusMessage.style.display = 'block';
					lightboxImage.style.display = 'none';
					downloadLink.style.display = 'none';
					viewLargeLink.style.display = 'none';

					let fileNameBase;
					let maxPages = paper.maxPages;
					let dateForFilename;

					if (paper.type === 'formula') {
						dateForFilename = {y: year, m: month, d: day};
						if (id === 'jangal_qamari') {
							fileNameBase = `${paper.prefix} ${dateForFilename.y}${dateForFilename.m}${dateForFilename.d} AH`;
						} else if (id === 'yaghma' && paper.calendar_type === 'shamsi') {
							const shamsiInputYear = parseInt(dateForFilename.y, 10);
							const shamsiInputMonth = parseInt(dateForFilename.m, 10);

							if (shamsiInputYear >= 1327 && shamsiInputYear <= 1357 && shamsiInputMonth >= 1 && shamsiInputMonth <= 12) {
								const volume = shamsiInputYear - 1327 + 1;
								const issueNumber = shamsiInputMonth;
								fileNameBase = `Yaghma, Vol. ${volume}, No. ${issueNumber}, ${shamsiInputYear} SH`;
							} else {
								console.error("Yaghma lightbox: Date out of range for filename", shamsiInputYear, shamsiInputMonth);
								lightboxStatusMessage.style.display = 'none';
								lightboxErrorMessage.textContent = `اطلاعات نشریه یغما برای این تاریخ در لایت‌باکس یافت نشد.`;
								lightboxErrorMessage.style.display = 'block';
								return;
							}
						} else if (id === 'negin' && paper.calendar_type === 'shamsi') {
							const shamsiInputYear = parseInt(dateForFilename.y, 10);
							const shamsiInputMonth = parseInt(dateForFilename.m, 10);
							const startDateCheck = shamsiInputYear > 1344 || (shamsiInputYear === 1344 && shamsiInputMonth >= 3);
							const endDateCheck = shamsiInputYear < 1359 || (shamsiInputYear === 1359 && shamsiInputMonth <= 1);

							if (startDateCheck && endDateCheck) {
								const volume = shamsiInputYear - 1344 + 1;
								let issueNumber;
								if (shamsiInputYear === 1344) {
									issueNumber = shamsiInputMonth - 2;
								} else {
									const yearsAfter1344 = shamsiInputYear - 1345;
									const issuesInFullYears = yearsAfter1344 * 12;
									issueNumber = 10 + issuesInFullYears + shamsiInputMonth;
								}
								fileNameBase = `Negin, Vol. ${volume}, No. ${issueNumber}, ${shamsiInputYear} SH`;
							} else {
								console.error("Negin lightbox: Date out of range for filename", shamsiInputYear, shamsiInputMonth);
								lightboxStatusMessage.style.display = 'none';
								lightboxErrorMessage.textContent = `اطلاعات نشریه نگین برای این تاریخ در لایت‌باکس یافت نشد.`;
								lightboxErrorMessage.style.display = 'block';
								return;
							}
						} else {
							fileNameBase = `${paper.prefix}${dateForFilename.y}${dateForFilename.m}${dateForFilename.d}${paper.calendar_type === 'hijri' ? ' AH' : ''}`;
						}
					} else if (paper.type === 'database' && paper.currentIssue) {
						fileNameBase = paper.currentIssue.filename_base;
						maxPages = paper.currentIssue.pages || null;
						const issueDateParsed = parseDateString(paper.currentIssue.date);
						if(issueDateParsed) {
							dateForFilename = {y: issueDateParsed.year, m: pad(issueDateParsed.month), d: pad(issueDateParsed.day)};
						} else {
							console.error("Lightbox: Invalid date string in currentIssue for", id);
							lightboxStatusMessage.style.display = 'none';
							lightboxErrorMessage.textContent = `اطلاعات تاریخ نشریه برای نمایش در لایت‌باکس یافت نشد.`;
							lightboxErrorMessage.style.display = 'block';
							return;
						}
					} else {
						console.error("Lightbox: Issue data missing for DB paper or unknown state for:", id, "on date", year, month, day);
						lightboxStatusMessage.style.display = 'none';
						lightboxErrorMessage.textContent = `اطلاعات نشریه برای نمایش در لایت‌باکس یافت نشد.`;
						lightboxErrorMessage.style.display = 'block';
						return;
					}

					const fullFileNameWithPdf = `${fileNameBase}.pdf`;
					const hash = getWikimediaHash(paper, fullFileNameWithPdf);
					const fileNameForUrlPath = fullFileNameWithPdf.replace(/ /g, '_');

					const imageUrl = getIssueFileUrl(paper, { filename_base: fileNameBase }, lightboxCurrentPage, 800);

					lightboxImage.src = imageUrl;

					const wikimediaFileLink = `https://commons.wikimedia.org/w/index.php?title=File%3A${fileNameForUrlPath}&page=${lightboxCurrentPage}`;
					lightboxImage.onclick = () => {
						window.open(wikimediaFileLink, '_blank');
					};
					lightboxImage.style.cursor = 'pointer';

					try {
						await new Promise((resolve, reject) => {
							lightboxImage.onload = () => {
								lightboxStatusMessage.style.display = 'none';
								lightboxImage.style.display = 'block';
								lightboxImagePlaceholder.style.display = 'none';
								lightboxErrorMessage.style.display = 'none';
								resolve(true);
							};
							lightboxImage.onerror = () => {
								lightboxStatusMessage.style.display = 'none';
								lightboxImage.style.display = 'none';
								lightboxImagePlaceholder.style.display = 'flex';
								lightboxErrorMessage.textContent = `تصویر برای ${paper.title} و صفحه ${englishToPersianDigits(lightboxCurrentPage)} یافت نشد.`;
								lightboxErrorMessage.style.display = 'block';
								resolve(true);
							};
						});
						downloadLink.href = `https://upload.wikimedia.org/wikipedia/commons/${hash[0]}/${hash}/${fileNameForUrlPath}?download`;
						downloadLink.textContent = 'دانلود نشریه';
						downloadLink.style.display = 'inline-block';

						viewLargeLink.href = `https://upload.wikimedia.org/wikipedia/commons/thumb/${hash[0]}/${hash}/${fileNameForUrlPath}/page${lightboxCurrentPage}-2048px-${fileNameForUrlPath}.jpg`;
						viewLargeLink.style.display = 'inline-block';

					} catch (error) {
						downloadLink.style.display = 'none';
						viewLargeLink.style.display = 'none';
					}

					lightboxPrevPageButton.disabled = lightboxCurrentPage <= 1;
					lightboxNextPageButton.disabled = (maxPages !== null && maxPages !== Infinity && lightboxCurrentPage >= maxPages);
					lightboxPageNumberInput.disabled = false;
				}


				const isDatabasePaperWithIssues = paper.type === 'database' && paper.issues && paper.issues.length > 0;

				if (isDatabasePaperWithIssues && paper.source !== 'utlib') {
					issueNavLightbox.style.display = 'flex';
					const navState = paper.navState;
					if (navState && navState.currentIssue) {
						lightboxIssueNumberInput.value = navState.currentIssue.issue_number || '';
						lightboxIssueNumberInput.disabled = true;
						lightboxPrevIssueButton.disabled = navState.currentIndex <= 0;
						lightboxNextIssueButton.disabled = navState.currentIndex >= navState.issuesArray.length - 1;
					} else {
						lightboxIssueNumberInput.value = '';
						lightboxIssueNumberInput.disabled = true;
						lightboxPrevIssueButton.disabled = true;
						lightboxNextIssueButton.disabled = true;
					}
					lightboxViewAllIssuesButton.style.display = 'inline-block';
				} else {
					issueNavLightbox.style.display = 'none';
					lightboxViewAllIssuesButton.style.display = 'none';
				}

				const availableNewspapersForCurrentDate = Object.keys(newspaperData)
					.filter(key => {
						const p = newspaperData[key];
						if (!p || !p.available) return false;
						const matchesMode = (currentCalendarMode === 'shamsi' && p.calendar_type === 'shamsi') ||
											(currentCalendarMode === 'hijri' && p.calendar_type === 'hijri');
						return matchesMode;
					});
				
				availableNewspapersForCurrentDate.sort((aId, bId) => {
					const paperA = newspaperData[aId];
					const paperB = newspaperData[bId];
					return paperA.title.localeCompare(paperB.title, 'fa');
				});


				if (availableNewspapersForCurrentDate.length <= 1) {
					lightboxPrevNewspaperButton.style.display = 'none';
					lightboxNextNewspaperButton.style.display = 'none';
				} else {
					lightboxPrevNewspaperButton.style.display = 'inline-block';
					lightboxNextNewspaperButton.style.display = 'inline-block';
				}
			};

			const lightboxGoToPage = (direction) => {
				const paper = newspaperData[currentLightboxNewspaperId];
				if (!paper || paper.source === 'utlib') return;
				let currentPageBeforeChange = lightboxCurrentPage;
				if (direction === 'prev' && lightboxCurrentPage > 1) {
					lightboxCurrentPage--;
				} else if (direction === 'next') {
					let maxPages = paper.maxPages;
					if (maxPages !== null && maxPages !== Infinity && lightboxCurrentPage >= maxPages) {
						return;
					}
					lightboxCurrentPage++;
				}
				if (currentPageBeforeChange !== lightboxCurrentPage) {
					paper.currentPage = lightboxCurrentPage;
					updateLightboxContent();
				}
			};

			const lightboxChangeNewspaper = (direction) => {
				const availableNewspapers = Object.keys(newspaperData)
					.filter(key => {
						const p = newspaperData[key];
						if (!p || !p.available) return false;
						const matchesMode = (currentCalendarMode === 'shamsi' && p.calendar_type === 'shamsi') ||
											(currentCalendarMode === 'hijri' && p.calendar_type === 'hijri');
						return matchesMode;
					});
				
				availableNewspapers.sort((aId, bId) => {
					const paperA = newspaperData[aId];
					const paperB = newspaperData[bId];
					return paperA.title.localeCompare(paperB.title, 'fa');
				});


				if (availableNewspapers.length <= 1) return;
				const currentIndex = availableNewspapers.indexOf(currentLightboxNewspaperId);
				let newIndex;
				if (direction === 'prev') {
					newIndex = (currentIndex - 1 + availableNewspapers.length) % availableNewspapers.length;
				} else {
					newIndex = (currentIndex + 1) % availableNewspapers.length;
				}
				currentLightboxNewspaperId = availableNewspapers[newIndex];
				const newPaper = newspaperData[currentLightboxNewspaperId];
				if (newPaper) {
					lightboxCurrentPage = newPaper.currentPage;
				} else {
					lightboxCurrentPage = 1;
				}
				updateLightboxContent();
			};

			const updateIssueNavButtons = (newspaperId) => {
				const paper = newspaperData[newspaperId];
				if (!paper || !paper.navState) return;
				const { currentIndex, issuesArray, prevIssueBtn, nextIssueBtn } = paper.navState;
				if (!prevIssueBtn || !nextIssueBtn || !issuesArray) return;
				prevIssueBtn.disabled = currentIndex <= 0;
				nextIssueBtn.disabled = currentIndex >= issuesArray.length - 1;
			};

			const goToNewspaperIssue = (newspaperId, index) => {
				const paper = newspaperData[newspaperId];
				if (!paper || !paper.navState) return;
				const { issuesArray, issueNumberInput } = paper.navState;
				if (index < 0 || index >= issuesArray.length) return;
				
				paper.navState.currentIndex = index;
				paper.navState.currentIssue = issuesArray[index];

				const issue = issuesArray[index];
				if (!issueNumberInput || !issue) return;
				issueNumberInput.value = issue.issue_number || '';
				
				const issueDateParsed = parseDateString(issue.date);
				if (issueDateParsed) {
					if (paper.calendar_type === 'hijri') {
						hijriYearInput.value = issueDateParsed.year;
						hijriMonthSelect.value = issueDateParsed.month;
						hijriDayInput.value = issueDateParsed.day;
					} else if (paper.calendar_type === 'shamsi') {
						shamsiYearInput.value = issueDateParsed.year;
						shamsiMonthSelect.value = issueDateParsed.month;
						shamsiDayInput.value = issueDateParsed.day;
					}
				}

				currentLightboxNewspaperId = newspaperId;
				lightboxCurrentPage = 1;

				mainPageNumberInput.value = 1;
				Object.values(newspaperData).forEach(p => { if(p) p.currentPage = 1; });

				loadImage('date');
				updateIssueNavButtons(newspaperId);
				
				if (lightboxOverlay.classList.contains('visible') && currentLightboxNewspaperId === newspaperId) {
					updateLightboxContent();
				}

				updateUrlParameters(
					currentCalendarMode,
					currentCalendarMode === 'shamsi' ? shamsiYearInput.value : hijriYearInput.value,
					currentCalendarMode === 'shamsi' ? shamsiMonthSelect.value : hijriMonthSelect.value,
					currentCalendarMode === 'shamsi' ? shamsiDayInput.value : hijriDayInput.value
				);
			};

			const goToPrevNewspaperIssue = (newspaperId) => {
				const paper = newspaperData[newspaperId];
				if (!paper || !paper.navState) return;
				const { currentIndex } = paper.navState;
				if (currentIndex > 0) goToNewspaperIssue(newspaperId, currentIndex - 1);
			};

			const goToNextNewspaperIssue = (newspaperId) => {
				const paper = newspaperData[newspaperId];
				if (!paper || !paper.navState) return;
				const { currentIndex, issuesArray } = paper.navState;
				if (currentIndex < issuesArray.length - 1) goToNewspaperIssue(newspaperId, currentIndex + 1);
			};

			const goToNewspaperIssueByNumber = (newspaperId) => {
				const paper = newspaperData[newspaperId];
				if (!paper || !paper.navState) return;
				const { issueNumberInput, issuesArray } = paper.navState;
				if (!issueNumberInput) return;
				const issueNumberText = persianToEnglishDigits(issueNumberInput.value);
				const issueNumber = parseInt(issueNumberText);
				if (isNaN(issueNumber)) return;
				const issueIndex = issuesArray.findIndex(issue => issue.issue_number == issueNumber);
				if (issueIndex >= 0) goToNewspaperIssue(newspaperId, issueIndex);
			};

			const updateIssueNavigationVisibility = (newspaperId) => {
				const paper = newspaperData[newspaperId];
				if (!paper || paper.type !== 'database' || !paper.available || !paper.navState || !paper.navState.navigationDiv ||
					!paper.issues || paper.issues.length === 0 || paper.source === 'utlib') {
					if (paper && paper.navState && paper.navState.navigationDiv) {
						paper.navState.navigationDiv.style.display = 'none';
					}
					return;
				}

				const { navigationDiv, issueNumberInput, issuesArray } = paper.navState;
				navigationDiv.style.display = 'block';

				let currentYear, currentMonth, currentDay;
				if (currentCalendarMode === 'shamsi') {
					currentYear = parseInt(shamsiYearInput.value);
					currentMonth = parseInt(shamsiMonthSelect.value);
					currentDay = parseInt(shamsiDayInput.value);
				} else {
					currentYear = parseInt(hijriYearInput.value);
					currentMonth = parseInt(hijriMonthSelect.value);
					currentDay = parseInt(hijriDayInput.value);
				}

				let foundIndex = -1;
				const selectedDateString = `${currentYear}${pad(currentMonth)}${pad(currentDay)}`;

				if (paper.calendar_type === 'hijri') {
					if (paper.frequency === 'daily') {
						foundIndex = issuesArray.findIndex(issue => issue.date === selectedDateString);
					} else if (paper.frequency === 'monthly') {
						foundIndex = issuesArray.findIndex(issue => issue.date.substring(0, 6) === selectedDateString.substring(0, 6));
					}
				} else if (paper.calendar_type === 'shamsi') {
					if (paper.frequency === 'daily') {
						foundIndex = issuesArray.findIndex(issue => issue.date === selectedDateString);
					} else if (paper.frequency === 'monthly') {
						foundIndex = issuesArray.findIndex(issue => issue.date.substring(0, 6) === selectedDateString.substring(0, 6));
					}
				}


				paper.navState.currentIndex = foundIndex;
				paper.navState.currentIssue = foundIndex >= 0 ? issuesArray[foundIndex] : null;

				if (issueNumberInput) {
					if (foundIndex >= 0 && issuesArray[foundIndex]) {
						issueNumberInput.value = englishToPersianDigits(issuesArray[foundIndex].issue_number) || '';
					} else {
						issueNumberInput.value = '';
					}
				}
				updateIssueNavButtons(newspaperId);
			};

			const handleGlobalGoToFirstIssue = (paperId) => {
				const paper = newspaperData[paperId];
				if (!paper) {
					console.warn(`Cannot go to first issue for ${paperId}: Newspaper data not found.`);
					return;
				}

				let targetDate = null;
				if (paper.type === 'database' && paper.issues && paper.issues.length > 0) {
					const issuesToConsider = paper.navState && paper.navState.issuesArray
											? paper.navState.issuesArray
											: [...paper.issues].sort((a,b) => {
												const dateA = parseInt(a.date, 10);
												const dateB = parseInt(b.date, 10);
												return dateA - dateB;
											});
					const firstChronologicalIssue = issuesToConsider[0];
					if (firstChronologicalIssue) {
						const parsed = parseDateString(firstChronologicalIssue.date);
						if (parsed) {
							targetDate = {
								year: parsed.year,
								month: parsed.month,
								day: parsed.day,
								calendar_type: paper.calendar_type
							};
						}
					}
				} else if (paper.type === 'formula' && paper.firstIssueDate) {
					const dateStr = paper.firstIssueDate;
					targetDate = {
						year: parseInt(dateStr.substring(0, 4)),
						month: parseInt(dateStr.substring(4, 6)),
						day: parseInt(dateStr.substring(6, 8)),
						calendar_type: paper.calendar_type
					};
				}

				if (targetDate) {
					if (targetDate.calendar_type === 'shamsi' && currentCalendarMode !== 'shamsi') {
						shamsiCalendarRadio.checked = true;
						currentCalendarMode = 'shamsi';
					} else if (targetDate.calendar_type === 'hijri' && currentCalendarMode !== 'hijri') {
						hijriCalendarRadio.checked = true;
						currentCalendarMode = 'hijri';
					}
					handleCalendarChange(targetDate);

					updateUrlParameters(
						currentCalendarMode,
						currentCalendarMode === 'shamsi' ? shamsiYearInput.value : hijriYearInput.value,
						currentCalendarMode === 'shamsi' ? shamsiMonthSelect.value : hijriMonthSelect.value,
						currentCalendarMode === 'shamsi' ? shamsiDayInput.value : hijriDayInput.value
					);
				} else {
					console.warn(`No first issue date defined or available for ${paperId}.`);
				}
			};

			const updateGlobalGoToFirstIssueButtonsVisibility = () => {
				Object.values(newspaperData).forEach(paper => {
					if (paper.globalFirstIssueBtn) {
						const isPermanentlyAvailable = (paper.type === 'database' && paper.issues && paper.issues.length > 0) ||
														(paper.type === 'formula' && paper.firstIssueDate);

						if (isPermanentlyAvailable) {
							paper.globalFirstIssueBtn.style.display = 'inline-block';
							if (paper.available) {
								paper.globalFirstIssueBtn.classList.add('available-on-date');
							} else {
								paper.globalFirstIssueBtn.classList.remove('available-on-date');
							}
						} else {
							paper.globalFirstIssueBtn.style.display = 'none';
							paper.globalFirstIssueBtn.classList.remove('available-on-date');
						}
					}
				});
			};

			const openAllNewspapersIssuesModal = (initialPaperId = null) => {
				allIssuesModalErrorMessage.style.display = 'none';
				allIssuesModalNewspaperTitle.textContent = 'فهرست شماره‌های نشریات';
				newspaperSelectionContainer.innerHTML = '';
				issuesListContainer.innerHTML = '';
				issuesImageGridContainer.innerHTML = '';

				const dbPapersWithIssues = Object.values(newspaperData).filter(paper =>
					paper.type === 'database' && paper.issues && paper.issues.length > 0
				).sort((a, b) => {
					if (a.calendar_type === 'hijri' && b.calendar_type === 'shamsi') return -1;
					if (a.calendar_type === 'shamsi' && b.calendar_type === 'hijri') return 1;

					if (a.calendar_type === 'shamsi' && b.calendar_type === 'shamsi') {
						const yearA = a.source === 'utlib' && a.navState.issuesArray.length > 0 ? a.navState.issuesArray[0].year_shamsi : parseInt(a.firstIssueDate.substring(0, 4), 10);
						const yearB = b.source === 'utlib' && b.navState.issuesArray.length > 0 ? b.navState.issuesArray[0].year_shamsi : parseInt(b.firstIssueDate.substring(0, 4), 10);
						if (yearA !== yearB) return yearA - yearB;
						return a.title.localeCompare(b.title, 'fa');
					}

					const dateA = parseInt(a.firstIssueDate, 10);
					const dateB = parseInt(b.firstIssueDate, 10);
					if (dateA !== dateB) return dateA - dateB;

					return a.title.localeCompare(b.title, 'fa');
				});

				if (dbPapersWithIssues.length === 0) {
					allIssuesModalErrorMessage.textContent = 'هیچ نشریه‌ای با فهرست شماره در دیتابیس یافت نشد.';
					allIssuesModalErrorMessage.style.display = 'block';
				} else {
					let paperToSelectId = initialPaperId;

					dbPapersWithIssues.forEach(paper => {
						const paperButton = document.createElement('button');
						let buttonText = paper.title;
						if (paper.source === 'utlib') {
							buttonText += ' *';
						}
						paperButton.textContent = buttonText;
						paperButton.dataset.paperId = paper.id;
						paperButton.addEventListener('click', () => {
							displayIssuesForSelectedNewspaper(paper.id);
							Array.from(newspaperSelectionContainer.children).forEach(btn => {
								btn.classList.remove('selected');
							});
							paperButton.classList.add('selected');
						});
						newspaperSelectionContainer.appendChild(paperButton);

						if (initialPaperId && paper.id === initialPaperId) {
							paperToSelectId = paper.id;
						}
					});

					if (paperToSelectId) {
						displayIssuesForSelectedNewspaper(paperToSelectId);
						const selectedButton = newspaperSelectionContainer.querySelector(`button[data-paper-id="${paperToSelectId}"]`);
						if (selectedButton) {
							selectedButton.classList.add('selected');
						}
					} else if (dbPapersWithIssues.length > 0) {
						const firstPaperId = dbPapersWithIssues[0].id;
						displayIssuesForSelectedNewspaper(firstPaperId);
						if (newspaperSelectionContainer.children[0]) {
							newspaperSelectionContainer.children[0].classList.add('selected');
						}
					}
				}
				allIssuesModalOverlay.classList.add('visible');
			};

			const displayIssuesForSelectedNewspaper = (paperId) => {
				const paper = newspaperData[paperId];
				if (!paper || !paper.issues || paper.issues.length === 0) {
					issuesListContainer.innerHTML = '';
					issuesImageGridContainer.innerHTML = '';
					issuesListContainer.style.display = 'none';
					issuesImageGridContainer.style.display = 'none';
					allIssuesModalErrorMessage.textContent = 'اطلاعات شماره‌ها برای این نشریه موجود نیست.';
					allIssuesModalErrorMessage.style.display = 'block';
					allIssuesModalNewspaperTitle.textContent = 'فهرست شماره‌های نشریات';
					return;
				}

				allIssuesModalErrorMessage.style.display = 'none';
				issuesListContainer.innerHTML = '';
				issuesImageGridContainer.innerHTML = '';

				const issuesToDisplaySorted = [...paper.issues].sort((a,b) => {
					if (paper.source === 'utlib') {
						if (a.year_shamsi !== b.year_shamsi) return a.year_shamsi - b.year_shamsi;
						if (a.volume !== b.volume) return a.volume - b.volume;
						const numA = a.number === null ? -Infinity : a.number;
						const numB = b.number === null ? -Infinity : b.number;
						return numA - numB;
					} else {
						const dateA = parseInt(a.date, 10);
						const dateB = parseInt(b.date, 10);
						return dateA - dateB;
					}
				});

				let titleText = paper.title;
				if (paper.source === 'utlib') {
					titleText += ' *';
				}
				allIssuesModalNewspaperTitle.textContent = `${titleText} (${englishToPersianDigits(issuesToDisplaySorted.length)} شماره)`;

				const displayDates = showDatesCheckbox.checked;
				const displayImages = showImagesCheckbox.checked;

				if (paper.source === 'utlib') {
					const groupedByVolume = new Map();
					issuesToDisplaySorted.forEach(issue => {
						const volumeKey = issue.volume !== null ? englishToPersianDigits(issue.volume) : 'بدون دوره';
						if (!groupedByVolume.has(volumeKey)) {
							groupedByVolume.set(volumeKey, []);
						}
						groupedByVolume.get(volumeKey).push(issue);
					});

					const targetContainer = displayImages ? issuesImageGridContainer : issuesListContainer;
					targetContainer.style.display = displayImages ? 'grid' : 'flex';
					issuesListContainer.style.display = displayImages ? 'none' : 'flex';
					issuesImageGridContainer.style.display = displayImages ? 'grid' : 'none';

					const sortedVolumeKeys = Array.from(groupedByVolume.keys()).sort((a, b) => {
						const numA = parseInt(persianToEnglishDigits(a), 10);
						const numB = parseInt(persianToEnglishDigits(b), 10);
						if (!isNaN(numA) && !isNaN(numB)) {
							return numA - numB;
						}
						return a.localeCompare(b, 'fa');
					});

					sortedVolumeKeys.forEach(volumeKey => {
						const volumeHeader = document.createElement('div');
						volumeHeader.classList.add('volume-header');
						volumeHeader.textContent = `دوره: ${volumeKey}`;
						targetContainer.appendChild(volumeHeader);

						const currentVolumeIssues = groupedByVolume.get(volumeKey);
						currentVolumeIssues.forEach(issue => {
							const issueNumberText = issue.number === null ? 'نامشخص' : englishToPersianDigits(issue.number);
                            let displayYear = '';
                            if (paper.calendar_type === 'hijri' && issue.year_hijri !== undefined) {
                                displayYear = englishToPersianDigits(issue.year_hijri);
                            } else {
                                displayYear = englishToPersianDigits(issue.year_shamsi);
                            }
							const issueText = `شمارهٔ ${issueNumberText}, سال ${displayYear}`;
							const issueUrl = getIssueFileUrl(paper, issue);

							if (displayImages) {
								const thumbnailItem = document.createElement('a');
								thumbnailItem.classList.add('issue-thumbnail-item');
								thumbnailItem.href = issueUrl;
								thumbnailItem.target = '_blank';
								thumbnailItem.style.textDecoration = 'none';

								const thumbnailImage = document.createElement('div');
								thumbnailImage.classList.add('newspaper-image-placeholder');
								thumbnailImage.textContent = 'تصویر در دسترس نیست';
								thumbnailImage.alt = `تصویر شماره ${issueNumberText} ${paper.title}`;

								const thumbnailText = document.createElement('span');
								thumbnailText.classList.add('issue-thumbnail-text');
								thumbnailText.textContent = issueText;

								thumbnailItem.appendChild(thumbnailImage);
								thumbnailItem.appendChild(thumbnailText);
								targetContainer.appendChild(thumbnailItem);
							} else {
								const issueButton = document.createElement('a');
								issueButton.textContent = issueText;
								issueButton.classList.add('issue-item-button');
								issueButton.href = issueUrl;
								issueButton.target = '_blank';
								issueButton.style.textDecoration = 'none';
								targetContainer.appendChild(issueButton);
							}
						});
					});

				} else {
					if (displayImages) {
						issuesListContainer.style.display = 'none';
						issuesImageGridContainer.style.display = 'grid';

						issuesToDisplaySorted.forEach(issue => {
							const issueDateParsed = parseDateString(issue.date);
							if (!issueDateParsed) return;

							const fullFileNameWithPdf = `${issue.filename_base}.pdf`;
							const hash = getWikimediaHash(paper, fullFileNameWithPdf);
							const fileNameForUrlPath = fullFileNameWithPdf.replace(/ /g, '_');
							const thumbnailUrl = `https://upload.wikimedia.org/wikipedia/commons/thumb/${hash[0]}/${hash}/${fileNameForUrlPath}/page1-120px-${fileNameForUrlPath}.jpg`;
							const issueUrl = getIssueFileUrl(paper, issue);

							const thumbnailItem = document.createElement('div');
							thumbnailItem.classList.add('issue-thumbnail-item');

							const thumbnailImage = document.createElement('img');
							thumbnailImage.classList.add('issue-thumbnail-image');
							thumbnailImage.src = thumbnailUrl;
							thumbnailImage.alt = `تصویر شماره ${englishToPersianDigits(issue.issue_number)} ${paper.title}`;
							thumbnailImage.onerror = (e) => {
								const placeholder = document.createElement('div');
								placeholder.classList.add('newspaper-image-placeholder');
								placeholder.textContent = 'تصویر در دسترس نیست';
								e.target.replaceWith(placeholder);
							};

							const thumbnailText = document.createElement('span');
							thumbnailText.classList.add('issue-thumbnail-text');
							thumbnailText.textContent = `شمارهٔ ${englishToPersianDigits(issue.issue_number)}`;

							if (displayDates) {
								let monthNamesArray = [];
								if (paper.calendar_type === 'shamsi') {
									monthNamesArray = shamsiMonthNames;
								} else {
									monthNamesArray = hijriMonthNames;
								}
								const monthName = monthNamesArray[issueDateParsed.month - 1];
								if (paper.frequency === 'monthly') {
									thumbnailText.textContent += `\n${monthName} ${englishToPersianDigits(issueDateParsed.year)}`;
								} else {
									thumbnailText.textContent += `\n${englishToPersianDigits(issueDateParsed.day)} ${monthName} ${englishToPersianDigits(issueDateParsed.year)}`;
								}
							}
							
							const link = document.createElement('a');
							link.href = 'javascript:void(0)';
							link.onclick = (e) => {
								e.preventDefault();
								goToIssueFromModal(paper.id, issue);
							};
							link.appendChild(thumbnailImage);
							link.appendChild(thumbnailText);
							thumbnailItem.appendChild(link);
							issuesImageGridContainer.appendChild(thumbnailItem);

						});

					} else {
						issuesListContainer.style.display = 'flex';
						issuesImageGridContainer.style.display = 'none';

						issuesToDisplaySorted.forEach(issue => {
							const issueButton = document.createElement('a');
							let buttonText = `شمارهٔ ${englishToPersianDigits(issue.issue_number)}`;

							if (displayDates) {
								const issueDateParsed = parseDateString(issue.date);
								if (issueDateParsed) {
									let monthNamesArray = [];
									if (paper.calendar_type === 'shamsi') {
										monthNamesArray = shamsiMonthNames;
									} else {
										monthNamesArray = hijriMonthNames;
									}

									const monthName = monthNamesArray[issueDateParsed.month - 1];

									if (paper.frequency === 'monthly') {
										buttonText += `, ${monthName} ${englishToPersianDigits(issueDateParsed.year)}`;
									} else {
										buttonText += `, روز ${englishToPersianDigits(issueDateParsed.day)} ${monthName} ${englishToPersianDigits(issueDateParsed.year)}`;
									}
								}
							}

							issueButton.textContent = buttonText;
							issueButton.classList.add('issue-item-button');
							issueButton.href = 'javascript:void(0)';
							issueButton.onclick = (e) => {
								e.preventDefault();
								goToIssueFromModal(paper.id, issue);
							};
							issuesListContainer.appendChild(issueButton);
						});
					}
				}
			};

			const closeAllIssuesModal = () => {
				allIssuesModalOverlay.classList.remove('visible');
			};

			const goToIssueFromModal = async (paperId, issue) => {
				const paper = newspaperData[paperId];
				if (!paper) return;

				if (paper.source === 'utlib') {
					window.open(getIssueFileUrl(paper, issue), '_blank');
					closeAllIssuesModal();
					return;
				}

				const issueDateParsed = parseDateString(issue.date);
				if (!issueDateParsed) return;

				if (paper) {
					paper.currentIssue = issue;
					if (paper.navState) {
						paper.navState.currentIndex = paper.navState.issuesArray.findIndex(i => i.filename_base === issue.filename_base);
					}
				}

				if (newspaperData[paperId].calendar_type === 'shamsi') {
					if (currentCalendarMode !== 'shamsi') {
						shamsiCalendarRadio.checked = true;
						currentCalendarMode = 'shamsi';
					}
					shamsiYearInput.value = issueDateParsed.year;
					shamsiMonthSelect.value = issueDateParsed.month;
					shamsiDayInput.value = issueDateParsed.day;
				} else {
					if (currentCalendarMode !== 'hijri') {
						hijriCalendarRadio.checked = true;
						currentCalendarMode = 'hijri';
					}
					hijriYearInput.value = issueDateParsed.year;
					hijriMonthSelect.value = issueDateParsed.month;
					hijriDayInput.value = issueDateParsed.day;
				}

				updateUrlParameters(
					currentCalendarMode,
					currentCalendarMode === 'shamsi' ? shamsiYearInput.value : hijriYearInput.value,
					currentCalendarMode === 'shamsi' ? shamsiMonthSelect.value : hijriMonthSelect.value,
					currentCalendarMode === 'shamsi' ? shamsiDayInput.value : hijriDayInput.value
				);

				closeAllIssuesModal();
				await loadImage('date');
				openLightbox(paperId);
			};

			const populateCalendarYearDropdown = () => {
				for (let year = minCalendarYear; year <= maxCalendarYear; year++) {
					const option = new Option(englishToPersianDigits(year), year);
					calendarYearSelect.add(option);
				}
			};

			const openCalendarModal = () => {
				if (currentCalendarMode === 'shamsi') {
					shamsiCalendarModalErrorMessage.style.display = 'none';
					shamsiCalendarModalOverlay.classList.add('visible');
					shamsiCalendarYearSelect.value = shamsiYearInput.value;
					renderShamsiCalendar(parseInt(shamsiYearInput.value, 10));
				} else {
					calendarModalErrorMessage.style.display = 'none';
					calendarModalOverlay.classList.add('visible');
					calendarYearSelect.value = hijriYearInput.value;
					renderCalendar(parseInt(hijriYearInput.value, 10));
				}
			};

			const closeCalendarModal = () => {
				calendarModalOverlay.classList.remove('visible');
				shamsiCalendarModalOverlay.classList.remove('visible');
			};

			const renderCalendar = (year) => {
				currentCalendarYear = year;
				calendarYearSelect.value = year;
				calendarGridContainer.innerHTML = '';

				prevYearBtn.disabled = currentCalendarYear <= minCalendarYear;
				nextYearBtn.disabled = currentCalendarYear >= maxCalendarYear;

				calendarModalTitle.textContent = `تقویم قمری سال ${englishToPersianDigits(currentCalendarYear)}`;

				const selectedHijriYear = parseInt(hijriYearInput.value, 10);
				const selectedHijriMonth = parseInt(hijriMonthSelect.value, 10);
				const selectedHijriDay = parseInt(hijriDayInput.value, 10);


				const maxDaysToDisplay = 30;

				for (let month = 1; month <= 12; month++) {
					const monthDiv = document.createElement('div');
					monthDiv.classList.add('calendar-month');

					const monthTitle = document.createElement('h3');
					monthTitle.textContent = hijriMonthNames[month - 1];
					monthDiv.appendChild(monthTitle);

					const daysGrid = document.createElement('div');
					daysGrid.classList.add('calendar-days');

					for (let day = 1; day <= maxDaysToDisplay; day++) {
						const dayBtn = document.createElement('button');
						dayBtn.textContent = englishToPersianDigits(day);
						dayBtn.classList.add('calendar-day-btn');

						const dateString = `${year}${pad(month)}${pad(day)}`;
						const issueCount = availableHijriDates.get(dateString) || 0;

						if (issueCount > 0) {
							dayBtn.classList.add('has-issue');
							if (issueCount === 1) {
								dayBtn.classList.add('issue-count-1');
							} else if (issueCount === 2) {
								dayBtn.classList.add('issue-count-2');
								dayBtn.classList.add('has-multiple-issues');
							} else {
								dayBtn.classList.add('issue-count-3plus');
								dayBtn.classList.add('has-multiple-issues');
							}
						}

						if (year === selectedHijriYear && month === selectedHijriMonth && day === selectedHijriDay) {
							dayBtn.classList.add('selected-day');
						}

						dayBtn.addEventListener('click', () => {
							goToDateFromCalendar(year, month, day);
						});
						daysGrid.appendChild(dayBtn);
					}
					monthDiv.appendChild(daysGrid);
					calendarGridContainer.appendChild(monthDiv);
				}
			};

			const goToDateFromCalendar = (year, month, day) => {
				hijriCalendarRadio.checked = true;
				currentCalendarMode = 'hijri';
				handleCalendarChange();

				hijriYearInput.value = year;
				hijriMonthSelect.value = month;
				hijriDayInput.value = day;

				updateUrlParameters(
					currentCalendarMode,
					hijriYearInput.value,
					hijriMonthSelect.value,
					hijriDayInput.value
				);

				closeCalendarModal();
				loadImage('date');
			};

			const renderShamsiCalendar = (year) => {
				shamsiCalendarYearSelect.value = year;
				shamsiCalendarGridContainer.innerHTML = '';

				shamsiPrevYearBtn.disabled = year <= 1305;
				shamsiNextYearBtn.disabled = year >= 1373;

				shamsiCalendarModalTitle.textContent = `تقویم شمسی سال ${englishToPersianDigits(year)}`;

				const selectedShamsiYear = parseInt(shamsiYearInput.value, 10);
				const selectedShamsiMonth = parseInt(shamsiMonthSelect.value, 10);
				const selectedShamsiDay = parseInt(shamsiDayInput.value, 10);

				for (let month = 1; month <= 12; month++) {
					const monthDiv = document.createElement('div');
					monthDiv.classList.add('calendar-month');

					const monthTitle = document.createElement('h3');
					monthTitle.textContent = shamsiMonthNames[month - 1];
					monthDiv.appendChild(monthTitle);

					const daysGrid = document.createElement('div');
					daysGrid.classList.add('calendar-days');

					const daysInMonth = shamsiDaysInMonth(year, month);

					for (let day = 1; day <= daysInMonth; day++) {
						const dayBtn = document.createElement('button');
						dayBtn.textContent = englishToPersianDigits(day);
						dayBtn.classList.add('calendar-day-btn');

						const dateString = `${year}${pad(month)}${pad(day)}`;
						const issueCount = availableShamsiDates.get(dateString) || 0;

						if (issueCount > 0) {
							dayBtn.classList.add('has-issue');
							if (issueCount === 1) {
								dayBtn.classList.add('issue-count-1');
							} else if (issueCount === 2) {
								dayBtn.classList.add('issue-count-2');
								dayBtn.classList.add('has-multiple-issues');
							} else {
								dayBtn.classList.add('issue-count-3plus');
								dayBtn.classList.add('has-multiple-issues');
							}
						}

						if (year === selectedShamsiYear && month === selectedShamsiMonth && day === selectedShamsiDay) {
							dayBtn.classList.add('selected-day');
						}

						dayBtn.addEventListener('click', () => {
							goToDateFromShamsiCalendar(year, month, day);
						});
						daysGrid.appendChild(dayBtn);
					}
					monthDiv.appendChild(daysGrid);
					shamsiCalendarGridContainer.appendChild(monthDiv);
				}
			};

			const goToDateFromShamsiCalendar = (year, month, day) => {
				shamsiCalendarRadio.checked = true;
				currentCalendarMode = 'shamsi';
				handleCalendarChange();

				shamsiYearInput.value = year;
				shamsiMonthSelect.value = month;
				shamsiDayInput.value = day;

				updateUrlParameters(
					currentCalendarMode,
					shamsiYearInput.value,
					shamsiMonthSelect.value,
					shamsiDayInput.value
				);

				closeCalendarModal();
				loadImage('date');
			};

			const setShowDatesCheckboxDefault = () => {
				showDatesCheckbox.checked = window.innerWidth > 768;
			};

			const setShowImagesCheckboxDefault = () => {
				showImagesCheckbox.checked = false;
			};

			shamsiCalendarRadio.addEventListener('change', () => {
				currentCalendarMode = 'shamsi';
				handleCalendarChange();
			});

			hijriCalendarRadio.addEventListener('change', () => {
				currentCalendarMode = 'hijri';
				handleCalendarChange();
			});

			[shamsiYearInput, shamsiMonthSelect, shamsiDayInput, hijriYearInput, hijriMonthSelect, hijriDayInput].forEach(el => {
				if(el) el.addEventListener('change', () => {
					if (currentCalendarMode === 'shamsi') {
						updateUrlParameters(
							'shamsi',
							shamsiYearInput.value,
							shamsiMonthSelect.value,
							shamsiDayInput.value
						);
					} else {
						updateUrlParameters(
							'hijri',
							hijriYearInput.value,
							hijriMonthSelect.value,
							hijriDayInput.value
						);
					}
					loadImage('date');
				});
			});

			if(mainPageNumberInput) mainPageNumberInput.addEventListener('change', () => {
				loadImage('pageInput');
				if (currentCalendarMode === 'shamsi') {
					updateUrlParameters(
						'shamsi',
						shamsiYearInput.value,
						shamsiMonthSelect.value,
						shamsiDayInput.value
					);
				} else {
					updateUrlParameters(
						'hijri',
						hijriYearInput.value,
						hijriMonthSelect.value,
						hijriDayInput.value
					);
				}
			});

			lightboxCloseButton.addEventListener('click', closeLightbox);
			lightboxOverlay.addEventListener('click', (e) => { if (e.target === lightboxOverlay) closeLightbox(); });
			lightboxPrevPageButton.addEventListener('click', () => lightboxGoToPage('prev'));
			lightboxNextPageButton.addEventListener('click', () => lightboxGoToPage('next'));
			lightboxPageNumberInput.addEventListener('change', () => {
				const inputPageValue = persianToEnglishDigits(lightboxPageNumberInput.value);
				const parsedInputPage = parseInt(inputPageValue, 10);
				if (!isNaN(parsedInputPage) && parsedInputPage >= 1) {
					const paper = newspaperData[currentLightboxNewspaperId];
					if (paper) {
						let maxPages = paper.maxPages;
						if (maxPages !== null && maxPages !== Infinity && parsedInputPage > maxPages) {
							lightboxCurrentPage = maxPages;
						} else {
							lightboxCurrentPage = parsedInputPage;
						}
						paper.currentPage = lightboxCurrentPage;
						updateLightboxContent();
					}
				} else {
					lightboxPageNumberInput.value = lightboxCurrentPage;
				}
			});
			lightboxPrevNewspaperButton.addEventListener('click', () => lightboxChangeNewspaper('prev'));
			lightboxNextNewspaperButton.addEventListener('click', () => lightboxChangeNewspaper('next'));

			lightboxPrevIssueButton.addEventListener('click', () => {
				goToPrevNewspaperIssue(currentLightboxNewspaperId);
			});
			lightboxNextIssueButton.addEventListener('click', () => {
				goToNextNewspaperIssue(currentLightboxNewspaperId);
			});
			lightboxViewAllIssuesButton.addEventListener('click', () => {
				openAllNewspapersIssuesModal(currentLightboxNewspaperId);
				closeLightbox();
			});


			document.addEventListener('keydown', (e) => {
				if (lightboxOverlay.classList.contains('visible')) {
					const paper = newspaperData[currentLightboxNewspaperId];
					if (paper && paper.source !== 'utlib') {
						if (e.key === 'ArrowLeft') {
							e.preventDefault();
							lightboxGoToPage('prev');
						} else if (e.key === 'ArrowRight') {
							e.preventDefault();
							lightboxGoToPage('next');
						}
					}
					if (e.key === 'Escape') {
						closeLightbox();
					}
				}
			});

			openAllNewspapersIssuesModalBtn.addEventListener('click', () => {
				openAllNewspapersIssuesModal();
			});
			allIssuesModalCloseButton.addEventListener('click', closeAllIssuesModal);
			allIssuesModalOverlay.addEventListener('click', (e) => {
				if (e.target === allIssuesModalOverlay) {
					closeAllIssuesModal();
				}
			});
			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && allIssuesModalOverlay.classList.contains('visible')) {
					closeCalendarModal();
				}
			});

			showDatesCheckbox.addEventListener('change', () => {
				const currentSelectedPaperButton = newspaperSelectionContainer.querySelector('button.selected');
				if (currentSelectedPaperButton) {
					const paperId = currentSelectedPaperButton.dataset.paperId;
					displayIssuesForSelectedNewspaper(paperId);
				} else {
					const dbPapersWithIssues = Object.values(newspaperData).filter(paper =>
						paper.type === 'database' && paper.issues && paper.issues.length > 0
					).sort((a, b) => {
						if (a.calendar_type === 'hijri' && b.calendar_type === 'shamsi') return -1;
						if (a.calendar_type === 'shamsi' && b.calendar_type === 'hijri') return 1;

						if (a.calendar_type === 'shamsi' && b.calendar_type === 'shamsi') {
							const yearA = a.source === 'utlib' && a.navState.issuesArray.length > 0 ? a.navState.issuesArray[0].year_shamsi : parseInt(a.firstIssueDate.substring(0, 4), 10);
							const yearB = b.source === 'utlib' && b.navState.issuesArray.length > 0 ? b.navState.issuesArray[0].year_shamsi : parseInt(b.firstIssueDate.substring(0, 4), 10);
							if (yearA !== yearB) return yearA - yearB;
							return a.title.localeCompare(b.title, 'fa');
						}

						const dateA = parseInt(a.firstIssueDate, 10);
						const dateB = parseInt(b.firstIssueDate, 10);
						if (dateA !== dateB) return dateA - dateB;

						return a.title.localeCompare(b.title, 'fa');
					});

					if (dbPapersWithIssues.length > 0) {
						displayIssuesForSelectedNewspaper(dbPapersWithIssues[0].id);
					}
				}
			});

			showImagesCheckbox.addEventListener('change', () => {
				const currentSelectedPaperButton = newspaperSelectionContainer.querySelector('button.selected');
				if (currentSelectedPaperButton) {
					const paperId = currentSelectedPaperButton.dataset.paperId;
					displayIssuesForSelectedNewspaper(paperId);
				} else {
					const dbPapersWithIssues = Object.values(newspaperData).filter(paper =>
						paper.type === 'database' && paper.issues && paper.issues.length > 0
					).sort((a, b) => {
						if (a.calendar_type === 'hijri' && b.calendar_type === 'shamsi') return -1;
						if (a.calendar_type === 'shamsi' && b.calendar_type === 'hijri') return 1;

						if (a.calendar_type === 'shamsi' && b.calendar_type === 'shamsi') {
							const yearA = a.source === 'utlib' && a.navState.issuesArray.length > 0 ? a.navState.issuesArray[0].year_shamsi : parseInt(a.firstIssueDate.substring(0, 4), 10);
							const yearB = b.source === 'utlib' && b.navState.issuesArray.length > 0 ? b.navState.issuesArray[0].year_shamsi : parseInt(b.firstIssueDate.substring(0, 4), 10);
							if (yearA !== yearB) return yearA - yearB;
							return a.title.localeCompare(b.title, 'fa');
						}

						const dateA = parseInt(a.firstIssueDate, 10);
						const dateB = parseInt(b.firstIssueDate, 10);
						if (dateA !== dateB) return dateA - dateB;

						return a.title.localeCompare(b.title, 'fa');
					});

					if (dbPapersWithIssues.length > 0) {
						displayIssuesForSelectedNewspaper(dbPapersWithIssues[0].id);
					}
				}
			});


			openCalendarModalBtn.addEventListener('click', () => {
				openCalendarModal();
			});
			populateCalendarYearDropdown();

			calendarYearSelect.addEventListener('change', (event) => {
				renderCalendar(parseInt(event.target.value, 10));
			});
			prevYearBtn.addEventListener('click', () => {
				if (currentCalendarYear > minCalendarYear) {
					renderCalendar(currentCalendarYear - 1);
				}
			});
			nextYearBtn.addEventListener('click', () => {
				if (currentCalendarYear < maxCalendarYear) {
					renderCalendar(currentCalendarYear + 1);
				}
			});
			calendarModalCloseButton.addEventListener('click', closeCalendarModal);
			calendarModalOverlay.addEventListener('click', (e) => {
				if (e.target === calendarModalOverlay) {
					closeCalendarModal();
				}
			});

			shamsiCalendarYearSelect.addEventListener('change', (event) => {
				renderShamsiCalendar(parseInt(event.target.value, 10));
			});
			shamsiPrevYearBtn.addEventListener('click', () => {
				const currentShamsiYear = parseInt(shamsiCalendarYearSelect.value, 10);
				if (currentShamsiYear > 1305) {
					renderShamsiCalendar(currentShamsiYear - 1);
				}
			});
			shamsiNextYearBtn.addEventListener('click', () => {
				const currentShamsiYear = parseInt(shamsiCalendarYearSelect.value, 10);
				if (currentShamsiYear < 1373) {
					renderShamsiCalendar(currentShamsiYear + 1);
				}
			});
			shamsiCalendarModalCloseButton.addEventListener('click', closeCalendarModal);
			shamsiCalendarModalOverlay.addEventListener('click', (e) => {
				if (e.target === shamsiCalendarModalOverlay) {
					closeCalendarModal();
				}
			});


			document.addEventListener('keydown', (e) => {
				if (e.key === 'Escape' && (calendarModalOverlay.classList.contains('visible') || shamsiCalendarModalOverlay.classList.contains('visible'))) {
					closeCalendarModal();
				}
			});

			initializeApp();
		});
	</script>
</body>
</html>
